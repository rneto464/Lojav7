<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peças - Gestão de Estoque</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style> 
        body { font-family: 'Inter', sans-serif; background-color: #f9fafb; } 
        .modal-transition { transition: opacity 0.3s ease-in-out; }
        .tab-active { border-bottom: 2px solid #2563eb; color: #2563eb; }
    </style>
</head>
<body class="text-gray-800">

    <div class="bg-blue-600 text-white shadow-lg">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-3">
                    <i data-lucide="wrench" class="w-8 h-8"></i>
                    <div>
                        <h1 class="text-xl font-bold leading-tight">Gestão de Estoque</h1>
                        <p class="text-blue-200 text-xs">Sistema Inteligente de Peças</p>
                    </div>
                </div>
            </div>
            
            <div class="flex space-x-4 text-sm font-medium">
                <a href="/" class="text-blue-100 px-4 py-2 hover:bg-white/10 rounded-md transition">Dashboard</a>
                <a href="/produtos" class="text-blue-100 px-4 py-2 hover:bg-white/10 rounded-md transition">Produtos</a>
                <a href="/fornecedores" class="text-blue-100 px-4 py-2 hover:bg-white/10 rounded-md transition">Fornecedores</a>
                <a href="/reparos" class="bg-white/20 px-4 py-2 rounded-md transition text-white">Peças</a>
                <a href="/financas" class="text-blue-100 px-4 py-2 hover:bg-white/10 rounded-md transition">Finanças</a>
                <a href="/movimentacoes" class="text-blue-100 px-4 py-2 hover:bg-white/10 rounded-md transition">Movimentações</a>
                <a href="/configuracoes" class="text-blue-100 px-4 py-2 hover:bg-white/10 rounded-md transition flex items-center justify-center" title="Configurações">
                    <i data-lucide="settings" class="w-5 h-5"></i>
                </a>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-6 py-8">
        
        <div class="flex justify-between items-center mb-8">
            <div>
                <h2 class="text-3xl font-bold text-gray-900">Peças e Serviços</h2>
                <p class="text-gray-500 mt-1">Gerencie peças físicas e serviços de mão de obra</p>
            </div>
            
            <div class="flex gap-3">
                <button id="btnCadastrarServico" onclick="abrirModalServico()" type="button" class="flex items-center gap-2 bg-purple-500 hover:bg-purple-600 text-white px-5 py-2.5 rounded-lg font-medium shadow-md transition transform hover:scale-105">
                    <i data-lucide="wrench" class="w-5 h-5"></i>
                    Cadastrar Serviço
                </button>
                <button id="btnCadastrarPeca" onclick="abrirModal()" type="button" class="flex items-center gap-2 bg-blue-500 hover:bg-blue-600 text-white px-5 py-2.5 rounded-lg font-medium shadow-md transition transform hover:scale-105">
                    <i data-lucide="plus" class="w-5 h-5"></i>
                    <span id="btnTexto">Cadastrar Peça</span>
                </button>
            </div>
        </div>

        <!-- Tabs -->
        <div class="mb-6 border-b border-gray-200">
            <div class="flex space-x-8">
                <button onclick="mostrarAba('pecas')" id="tab-pecas" class="tab-active pb-3 px-1 text-sm font-medium transition">
                    <i data-lucide="package" class="w-4 h-4 inline mr-2"></i>
                    Catálogo de Peças
                </button>
                <button onclick="mostrarAba('servicos')" id="tab-servicos" class="pb-3 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 transition">
                    <i data-lucide="wrench" class="w-4 h-4 inline mr-2"></i>
                    Tabela de Serviços
                </button>
            </div>
        </div>

        <!-- Conteúdo: Catálogo de Peças -->
        <div id="conteudo-pecas" class="aba-conteudo">
            <div class="space-y-4">
                {% if pecas %}
                    {% for peca in pecas %}
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 hover:shadow-md transition">
                        <div class="flex justify-between items-start">
                            <div class="flex gap-4 flex-1">
                                <div class="w-12 h-12 rounded-lg bg-orange-50 flex items-center justify-center text-orange-600 shrink-0">
                                    <i data-lucide="package" class="w-6 h-6"></i>
                                </div>
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-2">
                                        <h3 class="text-lg font-bold text-gray-900">{{ peca.device_model }}</h3>
                                        <span class="text-xs font-mono text-gray-400">#{{ peca.id }}</span>
                                    </div>
                                    <p class="text-sm text-gray-600 mb-1">
                                        <span class="font-medium">Peça:</span> {{ peca.part_name if peca.part_name else (peca.replaced_part if peca.replaced_part else "N/A") }}
                                    </p>
                                    <div class="flex gap-6 mt-3">
                                        <div>
                                            <p class="text-xs text-gray-400 mb-1">Preço de Venda</p>
                                            <p class="text-xl font-bold text-emerald-600">
                                                R$ {{ "%.2f"|format(peca.price) }}
                                            </p>
                                        </div>
                                        <div>
                                            <p class="text-xs text-gray-400 mb-1">Estoque</p>
                                            <p class="text-lg font-semibold {% if peca.available_stock <= peca.min_stock_alert %}text-red-600{% else %}text-gray-700{% endif %}">
                                                {{ peca.available_stock }} unidades
                                            </p>
                                        </div>
                                        {% if peca.cost_price and peca.cost_price > 0 %}
                                        <div>
                                            <p class="text-xs text-gray-400 mb-1">Custo de Compra</p>
                                            <p class="text-sm font-medium text-gray-600">
                                                R$ {{ "%.2f"|format(peca.cost_price) }}
                                            </p>
                                        </div>
                                        {% endif %}
                                        <div>
                                            <p class="text-xs text-gray-400 mb-1">Data de Cadastro</p>
                                            <p class="text-sm font-medium text-gray-600">
                                                {% if peca.created_at %}
                                                    {{ peca.created_at.strftime('%d/%m/%Y %H:%M') if hasattr(peca.created_at, 'strftime') else (peca.created_at[:16] if isinstance(peca.created_at, str) else 'N/A') }}
                                                {% else %}
                                                    N/A
                                                {% endif %}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="editarPeca({{ peca.id }})" class="text-blue-500 hover:text-blue-700 hover:bg-blue-50 p-2 rounded-lg transition" title="Editar">
                                    <i data-lucide="edit" class="w-5 h-5"></i>
                                </button>
                                <button onclick="excluirPeca({{ peca.id }}, '{{ peca.device_model }} - {{ peca.part_name if peca.part_name else (peca.replaced_part if peca.replaced_part else "N/A") }}')" class="text-red-500 hover:text-red-700 hover:bg-red-50 p-2 rounded-lg transition" title="Excluir">
                                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-12 text-center">
                        <div class="inline-block p-4 rounded-full bg-orange-50 mb-4">
                            <i data-lucide="package" class="w-10 h-10 text-orange-500"></i>
                        </div>
                        <h4 class="text-lg font-medium text-gray-900 mb-2">Nenhuma peça cadastrada</h4>
                        <p class="text-gray-500 text-sm">Comece cadastrando peças físicas no catálogo.</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Conteúdo: Tabela de Serviços -->
        <div id="conteudo-servicos" class="aba-conteudo hidden">
            <div class="space-y-4">
                {% if servicos %}
                    {% for servico in servicos %}
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 hover:shadow-md transition">
                        <div class="flex justify-between items-start">
                            <div class="flex gap-4 flex-1">
                                <div class="w-12 h-12 rounded-lg bg-purple-50 flex items-center justify-center text-purple-600 shrink-0">
                                    <i data-lucide="wrench" class="w-6 h-6"></i>
                                </div>
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-2">
                                        <h3 class="text-lg font-bold text-gray-900">{{ servico.name }}</h3>
                                        <span class="text-xs font-mono text-gray-400">#{{ servico.id }}</span>
                                        {% if servico.status == "active" %}
                                        <span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-700">Ativo</span>
                                        {% else %}
                                        <span class="px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-700">Inativo</span>
                                        {% endif %}
                                    </div>
                                    {% if servico.description %}
                                    <p class="text-sm text-gray-600 mb-1">
                                        {{ servico.description }}
                                    </p>
                                    {% endif %}
                                    <div class="flex gap-6 mt-3">
                                        <div>
                                            <p class="text-xs text-gray-400 mb-1">Preço</p>
                                            <p class="text-xl font-bold text-emerald-600">
                                                R$ {{ "%.2f"|format(servico.price) }}
                                            </p>
                                        </div>
                                        {% if servico.estimated_time %}
                                        <div>
                                            <p class="text-xs text-gray-400 mb-1">Tempo Estimado</p>
                                            <p class="text-sm font-medium text-gray-600">
                                                {{ servico.estimated_time }} min
                                            </p>
                                        </div>
                                        {% endif %}
                                        <div>
                                            <p class="text-xs text-gray-400 mb-1">Data de Cadastro</p>
                                            <p class="text-sm font-medium text-gray-600">
                                                {% if servico.created_at %}
                                                    {{ servico.created_at.strftime('%d/%m/%Y %H:%M') if hasattr(servico.created_at, 'strftime') else (servico.created_at[:16] if isinstance(servico.created_at, str) else 'N/A') }}
                                                {% else %}
                                                    N/A
                                                {% endif %}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="editarServico({{ servico.id }})" class="text-blue-500 hover:text-blue-700 hover:bg-blue-50 p-2 rounded-lg transition" title="Editar">
                                    <i data-lucide="edit" class="w-5 h-5"></i>
                                </button>
                                <button onclick="excluirServico({{ servico.id }}, '{{ servico.name }}')" class="text-red-500 hover:text-red-700 hover:bg-red-50 p-2 rounded-lg transition" title="Excluir">
                                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-12 text-center">
                        <div class="inline-block p-4 rounded-full bg-purple-50 mb-4">
                            <i data-lucide="wrench" class="w-10 h-10 text-purple-500"></i>
                        </div>
                        <h4 class="text-lg font-medium text-gray-900 mb-2">Nenhum serviço cadastrado</h4>
                        <p class="text-gray-500 text-sm">Comece cadastrando serviços de mão de obra.</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Conteúdo: Ordens de Serviço (removido - não mais necessário aqui) -->
        <div id="conteudo-ordens" class="aba-conteudo hidden" style="display: none;">
            <div class="mb-6 flex justify-between items-center">
                <div class="flex gap-4">
                    <select id="filtroStatus" onchange="filtrarOrdens()" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                        <option value="">Todas as ordens</option>
                        <option value="em_andamento">Em Andamento</option>
                        <option value="concluido">Concluídas</option>
                        <option value="cancelado">Canceladas</option>
                    </select>
                </div>
                <button id="btnNovaOrdem" onclick="abrirModalOrdem()" type="button" class="flex items-center gap-2 bg-blue-500 hover:bg-blue-600 text-white px-5 py-2.5 rounded-lg font-medium shadow-md transition transform hover:scale-105">
                    <i data-lucide="plus" class="w-5 h-5"></i>
                    Nova Ordem
                </button>
            </div>

            <div id="listaOrdens" class="space-y-4">
                {% if ordens %}
                    {% for ordem in ordens %}
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 hover:shadow-md transition">
                        <div class="flex justify-between items-start">
                            <div class="flex gap-4 flex-1">
                                <div class="w-12 h-12 rounded-lg {% if ordem.status == 'concluido' %}bg-green-50{% elif ordem.status == 'cancelado' %}bg-red-50{% else %}bg-blue-50{% endif %} flex items-center justify-center {% if ordem.status == 'concluido' %}text-green-600{% elif ordem.status == 'cancelado' %}text-red-600{% else %}text-blue-600{% endif %} shrink-0">
                                    <i data-lucide="clipboard-list" class="w-6 h-6"></i>
                                </div>
                                <div class="flex-1">
                                    <div class="flex items-center gap-3 mb-2">
                                        <h3 class="text-lg font-bold text-gray-900">{{ ordem.order_number }}</h3>
                                        <span class="px-2 py-1 text-xs font-semibold rounded-full {% if ordem.status == 'concluido' %}bg-green-100 text-green-700{% elif ordem.status == 'cancelado' %}bg-red-100 text-red-700{% else %}bg-blue-100 text-blue-700{% endif %}">
                                            {% if ordem.status == 'concluido' %}Concluída{% elif ordem.status == 'cancelado' %}Cancelada{% else %}Em Andamento{% endif %}
                                        </span>
                                    </div>
                                    <div class="grid grid-cols-2 gap-4 mb-3">
                                        <div>
                                            <p class="text-xs text-gray-400 mb-1">Cliente</p>
                                            <p class="text-sm font-medium text-gray-900">{{ ordem.client_name }}</p>
                                            {% if ordem.client_phone %}
                                            <p class="text-xs text-gray-500">{{ ordem.client_phone }}</p>
                                            {% endif %}
                                        </div>
                                        <div>
                                            <p class="text-xs text-gray-400 mb-1">Aparelho</p>
                                            <p class="text-sm font-medium text-gray-900">{{ ordem.device_model }}</p>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <p class="text-xs text-gray-400 mb-1">Serviço Realizado</p>
                                        <p class="text-sm text-gray-700">{{ ordem.service_description }}</p>
                                    </div>
                                    <div class="flex gap-6 mt-3">
                                        <div>
                                            <p class="text-xs text-gray-400 mb-1">Valor Total</p>
                                            <p class="text-xl font-bold text-emerald-600">
                                                R$ {{ "%.2f"|format(ordem.total_value or 0) }}
                                            </p>
                                        </div>
                                        {% if ordem.services and ordem.services|length > 0 %}
                                        <div>
                                            <p class="text-xs text-gray-400 mb-1">Serviços</p>
                                            <p class="text-sm font-medium text-gray-600">
                                                {% for service in ordem.services %}
                                                    {{ service.name }}{% if service.quantity > 1 %} ({{ service.quantity }}x){% endif %}{% if not loop.last %}, {% endif %}
                                                {% endfor %}
                                            </p>
                                        </div>
                                        {% endif %}
                                        <div>
                                            <p class="text-xs text-gray-400 mb-1">Data de Criação</p>
                                            <p class="text-sm font-medium text-gray-600">
                                                {% if ordem.created_at %}
                                                    {{ ordem.created_at.strftime('%d/%m/%Y %H:%M') if hasattr(ordem.created_at, 'strftime') else (ordem.created_at[:16] if isinstance(ordem.created_at, str) else ordem.created_at) }}
                                                {% else %}
                                                    N/A
                                                {% endif %}
                                            </p>
                                        </div>
                                        {% if ordem.completed_at %}
                                        <div>
                                            <p class="text-xs text-gray-400 mb-1">Data de Conclusão</p>
                                            <p class="text-sm font-medium text-green-600">
                                                {% if ordem.completed_at is string %}
                                                    {{ ordem.completed_at[:16] }}
                                                {% else %}
                                                    {{ ordem.completed_at.strftime('%d/%m/%Y %H:%M') if hasattr(ordem.completed_at, 'strftime') else ordem.completed_at }}
                                                {% endif %}
                                            </p>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="visualizarOrdem({{ ordem.id }})" class="text-blue-500 hover:text-blue-700 hover:bg-blue-50 p-2 rounded-lg transition" title="Visualizar">
                                    <i data-lucide="eye" class="w-5 h-5"></i>
                                </button>
                                <button onclick="editarOrdem({{ ordem.id }})" class="text-green-500 hover:text-green-700 hover:bg-green-50 p-2 rounded-lg transition" title="Editar">
                                    <i data-lucide="edit" class="w-5 h-5"></i>
                                </button>
                                <button onclick="excluirOrdem({{ ordem.id }}, '{{ ordem.order_number }}')" class="text-red-500 hover:text-red-700 hover:bg-red-50 p-2 rounded-lg transition" title="Excluir">
                                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-12 text-center">
                        <div class="inline-block p-4 rounded-full bg-blue-50 mb-4">
                            <i data-lucide="clipboard-list" class="w-10 h-10 text-blue-500"></i>
                        </div>
                        <h4 class="text-lg font-medium text-gray-900 mb-2">Nenhuma ordem de serviço cadastrada</h4>
                        <p class="text-gray-500 text-sm">Comece criando uma nova ordem de serviço.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Modal de Cadastro/Edição -->
    <div id="modalPeca" class="fixed inset-0 bg-black bg-opacity-50 modal-transition hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-gray-900" id="modalTitulo">Cadastrar Peça de Reparo</h3>
                    <button onclick="fecharModal()" class="text-gray-400 hover:text-gray-600 transition">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
            </div>

            <form id="formPeca" onsubmit="salvarPeca(event)" class="p-6 space-y-4">
                <input type="hidden" id="peca_id" name="peca_id">

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Modelo do Aparelho *</label>
                    <input type="text" id="device_model" name="device_model" required placeholder="Ex: iPhone 13, Samsung Galaxy S21" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Nome da Peça *</label>
                    <input type="text" id="part_name" name="part_name" required placeholder="Ex: Tela, Bateria, Conector de Carga" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Preço *</label>
                        <input type="number" step="0.01" min="0" id="price" name="price" required placeholder="0.00" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Custo de Compra</label>
                        <input type="number" step="0.01" min="0" id="cost_price" name="cost_price" placeholder="0.00" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Estoque Disponível</label>
                        <input type="number" min="0" id="available_stock" name="available_stock" value="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Alerta Mínimo de Estoque</label>
                        <input type="number" min="0" id="min_stock_alert" name="min_stock_alert" value="5" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Data de Cadastro (Opcional)</label>
                    <input type="datetime-local" id="peca_created_at" name="peca_created_at" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                    <p class="text-xs text-gray-500 mt-1">Deixe em branco para usar a data/hora atual</p>
                </div>

                <div class="pt-4 flex justify-end gap-3 border-t border-gray-200 mt-4">
                    <button type="button" onclick="fecharModal()" class="px-5 py-2 text-sm text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition">Cancelar</button>
                    <button type="submit" class="px-5 py-2 text-sm text-white bg-blue-600 hover:bg-blue-700 rounded-lg shadow-md transition">Salvar Peça</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Cadastro/Edição de Serviço -->
    <div id="modalServico" class="fixed inset-0 bg-black bg-opacity-50 modal-transition hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-gray-900" id="modalTituloServico">Cadastrar Serviço</h3>
                    <button onclick="fecharModalServico()" class="text-gray-400 hover:text-gray-600 transition">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
            </div>

            <form id="formServico" onsubmit="salvarServico(event)" class="p-6 space-y-4">
                <input type="hidden" id="servico_id" name="servico_id">

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Nome do Serviço *</label>
                    <input type="text" id="servico_name" name="servico_name" required placeholder="Ex: Troca de Tela, Formatação, Limpeza Química" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none">
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Descrição</label>
                    <textarea id="servico_description" name="servico_description" rows="3" placeholder="Descrição detalhada do serviço (opcional)" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none"></textarea>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Preço *</label>
                        <input type="number" step="0.01" min="0" id="servico_price" name="servico_price" required placeholder="0.00" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Tempo Estimado (minutos)</label>
                        <input type="number" min="0" id="servico_estimated_time" name="servico_estimated_time" placeholder="Ex: 30" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Status</label>
                    <select id="servico_status" name="servico_status" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none">
                        <option value="active">Ativo</option>
                        <option value="inactive">Inativo</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Data de Cadastro (Opcional)</label>
                    <input type="datetime-local" id="servico_created_at" name="servico_created_at" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none">
                    <p class="text-xs text-gray-500 mt-1">Deixe em branco para usar a data/hora atual</p>
                </div>

                <div class="pt-4 flex justify-end gap-3 border-t border-gray-200 mt-4">
                    <button type="button" onclick="fecharModalServico()" class="px-5 py-2 text-sm text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition">Cancelar</button>
                    <button type="submit" class="px-5 py-2 text-sm text-white bg-purple-600 hover:bg-purple-700 rounded-lg shadow-md transition">Salvar Serviço</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        lucide.createIcons();

        let abaAtiva = 'pecas';

        function mostrarAba(aba) {
            abaAtiva = aba;
            
            // Atualiza tabs
            document.querySelectorAll('[id^="tab-"]').forEach(tab => {
                tab.classList.remove('tab-active', 'text-blue-600');
                tab.classList.add('text-gray-500');
            });
            
            const tabAtiva = document.getElementById(`tab-${aba}`);
            if (tabAtiva) {
                tabAtiva.classList.add('tab-active', 'text-blue-600');
                tabAtiva.classList.remove('text-gray-500');
            }
            
            // Mostra/esconde conteúdo
            document.querySelectorAll('.aba-conteudo').forEach(conteudo => {
                conteudo.classList.add('hidden');
            });
            
            const conteudoAtivo = document.getElementById(`conteudo-${aba}`);
            if (conteudoAtivo) {
                conteudoAtivo.classList.remove('hidden');
            }
        }

        function abrirModal(pecaId = null) {
            const modal = document.getElementById('modalPeca');
            const form = document.getElementById('formPeca');
            const titulo = document.getElementById('modalTitulo');
            
            if (pecaId) {
                titulo.textContent = 'Editar Peça';
                carregarPeca(pecaId);
            } else {
                titulo.textContent = 'Cadastrar Peça';
                form.reset();
                document.getElementById('peca_id').value = '';
            }
            
            modal.classList.remove('hidden');
        }

        function fecharModal() {
            document.getElementById('modalPeca').classList.add('hidden');
        }

        async function carregarPeca(pecaId) {
            try {
                const response = await fetch(`/api/reparos`);
                const pecas = await response.json();
                const peca = pecas.find(p => p.id === pecaId);
                
                if (peca) {
                    document.getElementById('peca_id').value = peca.id;
                    document.getElementById('device_model').value = peca.device_model;
                    document.getElementById('part_name').value = peca.part_name || peca.replaced_part || '';
                    document.getElementById('price').value = peca.price;
                    document.getElementById('cost_price').value = peca.cost_price || '';
                    document.getElementById('available_stock').value = peca.available_stock || 0;
                    document.getElementById('min_stock_alert').value = peca.min_stock_alert || 5;
                    
                    // Carrega data de cadastro se existir
                    if (peca.created_at) {
                        const dataCadastro = new Date(peca.created_at);
                        const dataCadastroLocal = new Date(dataCadastro.getTime() - dataCadastro.getTimezoneOffset() * 60000);
                        document.getElementById('peca_created_at').value = dataCadastroLocal.toISOString().slice(0, 16);
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar peça:', error);
                alert('Erro ao carregar dados da peça');
            }
        }

        async function salvarPeca(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const pecaId = document.getElementById('peca_id').value;
            
            const dados = {
                device_model: formData.get('device_model'),
                part_name: formData.get('part_name'),
                price: parseFloat(formData.get('price')),
                cost_price: formData.get('cost_price') ? parseFloat(formData.get('cost_price')) : 0,
                available_stock: parseInt(formData.get('available_stock')) || 0,
                min_stock_alert: parseInt(formData.get('min_stock_alert')) || 5
            };
            
            // Adiciona data personalizada se fornecida
            const dataCadastro = formData.get('peca_created_at');
            if (dataCadastro) {
                dados.created_at = new Date(dataCadastro).toISOString();
            }
            
            try {
                let response;
                if (pecaId) {
                    response = await fetch(`/api/reparos/${pecaId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(dados)
                    });
                } else {
                    response = await fetch('/api/reparos', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(dados)
                    });
                }
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(result.message || 'Peça salva com sucesso!');
                    fecharModal();
                    location.reload();
                } else {
                    alert(result.message || 'Erro ao salvar peça');
                }
            } catch (error) {
                console.error('Erro ao salvar peça:', error);
                alert('Erro ao salvar peça');
            }
        }

        function editarPeca(pecaId) {
            abrirModal(pecaId);
        }

        async function excluirPeca(pecaId, nome) {
            if (!confirm(`Tem certeza que deseja excluir "${nome}"?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/reparos/${pecaId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(result.message || 'Peça excluída com sucesso!');
                    location.reload();
                } else {
                    alert(result.message || 'Erro ao excluir peça');
                }
            } catch (error) {
                console.error('Erro ao excluir peça:', error);
                alert('Erro ao excluir peça');
            }
        }

        // =========================================
        // FUNÇÕES PARA SERVIÇOS
        // =========================================

        function abrirModalServico(servicoId = null) {
            const modal = document.getElementById('modalServico');
            const form = document.getElementById('formServico');
            const titulo = document.getElementById('modalTituloServico');
            
            if (servicoId) {
                titulo.textContent = 'Editar Serviço';
                carregarServico(servicoId);
            } else {
                titulo.textContent = 'Cadastrar Serviço';
                form.reset();
                document.getElementById('servico_id').value = '';
            }
            
            modal.classList.remove('hidden');
        }

        function fecharModalServico() {
            document.getElementById('modalServico').classList.add('hidden');
        }

        async function carregarServico(servicoId) {
            try {
                const response = await fetch(`/api/servicos`);
                const servicos = await response.json();
                const servico = servicos.find(s => s.id === servicoId);
                
                if (servico) {
                    document.getElementById('servico_id').value = servico.id;
                    document.getElementById('servico_name').value = servico.name;
                    document.getElementById('servico_description').value = servico.description || '';
                    document.getElementById('servico_price').value = servico.price;
                    document.getElementById('servico_estimated_time').value = servico.estimated_time || '';
                    document.getElementById('servico_status').value = servico.status || 'active';
                }
            } catch (error) {
                console.error('Erro ao carregar serviço:', error);
                alert('Erro ao carregar dados do serviço');
            }
        }

        async function salvarServico(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const servicoId = document.getElementById('servico_id').value;
            
            const dados = {
                name: formData.get('servico_name'),
                description: formData.get('servico_description') || null,
                price: parseFloat(formData.get('servico_price')),
                estimated_time: formData.get('servico_estimated_time') ? parseInt(formData.get('servico_estimated_time')) : null,
                status: formData.get('servico_status') || 'active'
            };
            
            // Adiciona data personalizada se fornecida
            const dataCadastro = formData.get('servico_created_at');
            if (dataCadastro) {
                dados.created_at = new Date(dataCadastro).toISOString();
            }
            
            try {
                let response;
                if (servicoId) {
                    response = await fetch(`/api/servicos/${servicoId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(dados)
                    });
                } else {
                    response = await fetch('/api/servicos', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(dados)
                    });
                }
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(result.message || 'Serviço salvo com sucesso!');
                    fecharModalServico();
                    location.reload();
                } else {
                    alert(result.message || 'Erro ao salvar serviço');
                }
            } catch (error) {
                console.error('Erro ao salvar serviço:', error);
                alert('Erro ao salvar serviço');
            }
        }

        function editarServico(servicoId) {
            abrirModalServico(servicoId);
        }

        async function excluirServico(servicoId, nome) {
            if (!confirm(`Tem certeza que deseja excluir o serviço "${nome}"?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/servicos/${servicoId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(result.message || 'Serviço excluído com sucesso!');
                    location.reload();
                } else {
                    alert(result.message || 'Erro ao excluir serviço');
                }
            } catch (error) {
                console.error('Erro ao excluir serviço:', error);
                alert('Erro ao excluir serviço');
            }
        }

        // =========================================
        // FUNÇÕES PARA ORDENS DE SERVIÇO
        // =========================================
        let pecasSelecionadas = [];

        function abrirModalOrdem(ordemId = null) {
            const modal = document.getElementById('modalOrdem');
            const form = document.getElementById('formOrdem');
            const titulo = document.getElementById('modalTituloOrdem');
            const divStatus = document.getElementById('divStatus');
            
            if (ordemId) {
                titulo.textContent = 'Editar Ordem de Serviço';
                divStatus.classList.remove('hidden');
                carregarOrdem(ordemId);
            } else {
                titulo.textContent = 'Nova Ordem de Serviço';
                divStatus.classList.add('hidden');
                form.reset();
                document.getElementById('ordem_id').value = '';
                pecasSelecionadas = [];
                atualizarListaPecas();
            }
            
            modal.classList.remove('hidden');
        }

        function fecharModalOrdem() {
            document.getElementById('modalOrdem').classList.add('hidden');
        }

        function fecharModalVisualizar() {
            document.getElementById('modalVisualizar').classList.add('hidden');
        }

        function adicionarPeca() {
            const select = document.getElementById('selectPeca');
            const quantidade = document.getElementById('quantidadePeca');
            
            if (!select.value) {
                alert('Selecione uma peça');
                return;
            }
            
            const pecaId = parseInt(select.value);
            const quantidadeVal = parseInt(quantidade.value) || 1;
            const option = select.options[select.selectedIndex];
            const price = parseFloat(option.dataset.price);
            const model = option.dataset.model;
            const part = option.dataset.part;
            
            // Verifica se já existe
            const index = pecasSelecionadas.findIndex(p => p.repair_part_id === pecaId);
            if (index >= 0) {
                pecasSelecionadas[index].quantity += quantidadeVal;
            } else {
                pecasSelecionadas.push({
                    repair_part_id: pecaId,
                    quantity: quantidadeVal,
                    price: price,
                    model: model,
                    part: part
                });
            }
            
            atualizarListaPecas();
            select.value = '';
            quantidade.value = 1;
        }

        function removerPeca(index) {
            pecasSelecionadas.splice(index, 1);
            atualizarListaPecas();
        }

        function atualizarListaPecas() {
            const lista = document.getElementById('listaPecas');
            if (!lista) return;
            
            lista.innerHTML = '';
            
            pecasSelecionadas.forEach((peca, index) => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
                div.innerHTML = `
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-900">${peca.model} - ${peca.part}</p>
                        <p class="text-xs text-gray-500">Qtd: ${peca.quantity} × R$ ${peca.price.toFixed(2)} = R$ ${(peca.quantity * peca.price).toFixed(2)}</p>
                    </div>
                    <button type="button" onclick="removerPeca(${index})" class="text-red-500 hover:text-red-700 p-2">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                `;
                lista.appendChild(div);
            });
            
            lucide.createIcons();
        }

        async function carregarOrdem(ordemId) {
            try {
                const response = await fetch(`/api/ordens-servico/${ordemId}`);
                const ordem = await response.json();
                
                if (ordem) {
                    document.getElementById('ordem_id').value = ordem.id;
                    document.getElementById('client_name').value = ordem.client_name;
                    document.getElementById('client_phone').value = ordem.client_phone || '';
                    document.getElementById('client_email').value = ordem.client_email || '';
                    document.getElementById('device_model').value = ordem.device_model;
                    document.getElementById('service_description').value = ordem.service_description;
                    // labor_cost removido - serviços devem ser gerenciados separadamente
                    document.getElementById('notes').value = ordem.notes || '';
                    document.getElementById('status').value = ordem.status;
                    
                    // Carrega peças
                    pecasSelecionadas = ordem.parts.map(part => ({
                        repair_part_id: part.id,
                        quantity: part.quantity,
                        price: part.price,
                        model: part.device_model,
                        part: part.part_name || part.replaced_part || "N/A"
                    }));
                    atualizarListaPecas();
                }
            } catch (error) {
                console.error('Erro ao carregar ordem:', error);
                alert('Erro ao carregar dados da ordem');
            }
        }

        async function salvarOrdem(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const ordemId = document.getElementById('ordem_id').value;
            
            const dados = {
                client_name: formData.get('client_name'),
                client_phone: formData.get('client_phone') || null,
                client_email: formData.get('client_email') || null,
                device_model: formData.get('device_model'),
                service_description: formData.get('service_description'),
                services: [], // Serviços devem ser adicionados via API separadamente
                notes: formData.get('notes') || null,
                parts: pecasSelecionadas.map(p => ({
                    repair_part_id: p.repair_part_id,
                    quantity: p.quantity
                }))
            };
            
            if (ordemId) {
                dados.status = formData.get('status');
            }
            
            try {
                let response;
                if (ordemId) {
                    response = await fetch(`/api/ordens-servico/${ordemId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(dados)
                    });
                } else {
                    response = await fetch('/api/ordens-servico', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(dados)
                    });
                }
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(result.message || 'Ordem salva com sucesso!');
                    fecharModalOrdem();
                    location.reload();
                } else {
                    alert(result.message || 'Erro ao salvar ordem');
                }
            } catch (error) {
                console.error('Erro ao salvar ordem:', error);
                alert('Erro ao salvar ordem');
            }
        }

        async function visualizarOrdem(ordemId) {
            try {
                const response = await fetch(`/api/ordens-servico/${ordemId}`);
                const ordem = await response.json();
                
                const conteudo = document.getElementById('conteudoVisualizar');
                const titulo = document.getElementById('visualizarTitulo');
                titulo.textContent = `Ordem ${ordem.order_number}`;
                
                let html = `
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-xs text-gray-400 mb-1">Cliente</p>
                                <p class="text-sm font-medium text-gray-900">${ordem.client_name}</p>
                                ${ordem.client_phone ? `<p class="text-xs text-gray-500">${ordem.client_phone}</p>` : ''}
                                ${ordem.client_email ? `<p class="text-xs text-gray-500">${ordem.client_email}</p>` : ''}
                            </div>
                            <div>
                                <p class="text-xs text-gray-400 mb-1">Aparelho</p>
                                <p class="text-sm font-medium text-gray-900">${ordem.device_model}</p>
                            </div>
                        </div>
                        <div>
                            <p class="text-xs text-gray-400 mb-1">Descrição do Serviço</p>
                            <p class="text-sm text-gray-700">${ordem.service_description}</p>
                        </div>
                        ${ordem.parts && ordem.parts.length > 0 ? `
                        <div>
                            <p class="text-xs text-gray-400 mb-2">Peças Utilizadas</p>
                            <div class="space-y-2">
                                ${ordem.parts.map(part => `
                                    <div class="p-3 bg-gray-50 rounded-lg">
                                        <p class="text-sm font-medium text-gray-900">${part.device_model} - ${part.part_name || part.replaced_part || 'N/A'}</p>
                                        <p class="text-xs text-gray-500">Quantidade: ${part.quantity} × R$ ${part.price.toFixed(2)} = R$ ${(part.quantity * part.price).toFixed(2)}</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}
                        <div class="grid grid-cols-2 gap-4 pt-4 border-t">
                            ${ordem.services && ordem.services.length > 0 ? `
                            <div>
                                <p class="text-xs text-gray-400 mb-1">Serviços</p>
                                <p class="text-sm font-semibold text-gray-900">
                                    ${ordem.services.map(s => `${s.name}${s.quantity > 1 ? ` (${s.quantity}x)` : ''}`).join(', ')}
                                </p>
                                <p class="text-xs text-gray-500">
                                    Total: R$ ${ordem.services.reduce((sum, s) => sum + (s.price * s.quantity), 0).toFixed(2)}
                                </p>
                            </div>
                            ` : ''}
                            <div>
                                <p class="text-xs text-gray-400 mb-1">Valor Total</p>
                                <p class="text-xl font-bold text-emerald-600">R$ ${ordem.total_value.toFixed(2)}</p>
                            </div>
                        </div>
                        ${ordem.notes ? `
                        <div>
                            <p class="text-xs text-gray-400 mb-1">Observações</p>
                            <p class="text-sm text-gray-700">${ordem.notes}</p>
                        </div>
                        ` : ''}
                        <div class="pt-4 border-t">
                            <p class="text-xs text-gray-400 mb-1">Status</p>
                            <span class="px-2 py-1 text-xs font-semibold rounded-full ${ordem.status === 'concluido' ? 'bg-green-100 text-green-700' : ordem.status === 'cancelado' ? 'bg-red-100 text-red-700' : 'bg-blue-100 text-blue-700'}">
                                ${ordem.status === 'concluido' ? 'Concluída' : ordem.status === 'cancelado' ? 'Cancelada' : 'Em Andamento'}
                            </span>
                        </div>
                    </div>
                `;
                
                conteudo.innerHTML = html;
                document.getElementById('modalVisualizar').classList.remove('hidden');
            } catch (error) {
                console.error('Erro ao visualizar ordem:', error);
                alert('Erro ao carregar ordem');
            }
        }

        function editarOrdem(ordemId) {
            abrirModalOrdem(ordemId);
        }

        async function excluirOrdem(ordemId, numero) {
            if (!confirm(`Tem certeza que deseja excluir a ordem "${numero}"?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/ordens-servico/${ordemId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(result.message || 'Ordem excluída com sucesso!');
                    location.reload();
                } else {
                    alert(result.message || 'Erro ao excluir ordem');
                }
            } catch (error) {
                console.error('Erro ao excluir ordem:', error);
                alert('Erro ao excluir ordem');
            }
        }

        async function filtrarOrdens() {
            const status = document.getElementById('filtroStatus').value;
            const url = status ? `/api/ordens-servico?status=${status}` : '/api/ordens-servico';
            
            try {
                const response = await fetch(url);
                const ordens = await response.json();
                
                const lista = document.getElementById('listaOrdens');
                lista.innerHTML = '';
                
                if (ordens.length === 0) {
                    lista.innerHTML = `
                        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-12 text-center">
                            <div class="inline-block p-4 rounded-full bg-blue-50 mb-4">
                                <i data-lucide="clipboard-list" class="w-10 h-10 text-blue-500"></i>
                            </div>
                            <h4 class="text-lg font-medium text-gray-900 mb-2">Nenhuma ordem encontrada</h4>
                            <p class="text-gray-500 text-sm">Não há ordens com o filtro selecionado.</p>
                        </div>
                    `;
                    lucide.createIcons();
                    return;
                }
                
                ordens.forEach(ordem => {
                    const div = document.createElement('div');
                    div.className = 'bg-white rounded-xl shadow-sm border border-gray-100 p-6 hover:shadow-md transition';
                    div.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div class="flex gap-4 flex-1">
                                <div class="w-12 h-12 rounded-lg ${ordem.status === 'concluido' ? 'bg-green-50' : ordem.status === 'cancelado' ? 'bg-red-50' : 'bg-blue-50'} flex items-center justify-center ${ordem.status === 'concluido' ? 'text-green-600' : ordem.status === 'cancelado' ? 'text-red-600' : 'text-blue-600'} shrink-0">
                                    <i data-lucide="clipboard-list" class="w-6 h-6"></i>
                                </div>
                                <div class="flex-1">
                                    <div class="flex items-center gap-3 mb-2">
                                        <h3 class="text-lg font-bold text-gray-900">${ordem.order_number}</h3>
                                        <span class="px-2 py-1 text-xs font-semibold rounded-full ${ordem.status === 'concluido' ? 'bg-green-100 text-green-700' : ordem.status === 'cancelado' ? 'bg-red-100 text-red-700' : 'bg-blue-100 text-blue-700'}">
                                            ${ordem.status === 'concluido' ? 'Concluída' : ordem.status === 'cancelado' ? 'Cancelada' : 'Em Andamento'}
                                        </span>
                                    </div>
                                    <div class="grid grid-cols-2 gap-4 mb-3">
                                        <div>
                                            <p class="text-xs text-gray-400 mb-1">Cliente</p>
                                            <p class="text-sm font-medium text-gray-900">${ordem.client_name}</p>
                                            ${ordem.client_phone ? `<p class="text-xs text-gray-500">${ordem.client_phone}</p>` : ''}
                                        </div>
                                        <div>
                                            <p class="text-xs text-gray-400 mb-1">Aparelho</p>
                                            <p class="text-sm font-medium text-gray-900">${ordem.device_model}</p>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <p class="text-xs text-gray-400 mb-1">Serviço Realizado</p>
                                        <p class="text-sm text-gray-700">${ordem.service_description}</p>
                                    </div>
                                    <div class="flex gap-6 mt-3">
                                        <div>
                                            <p class="text-xs text-gray-400 mb-1">Valor Total</p>
                                            <p class="text-xl font-bold text-emerald-600">
                                                R$ ${ordem.total_value.toFixed(2)}
                                            </p>
                                        </div>
                                        ${ordem.services && ordem.services.length > 0 ? `
                                        <div>
                                            <p class="text-xs text-gray-400 mb-1">Serviços</p>
                                            <p class="text-sm font-medium text-gray-600">
                                                ${ordem.services.map(s => `${s.name}${s.quantity > 1 ? ` (${s.quantity}x)` : ''}`).join(', ')}
                                            </p>
                                        </div>
                                        ` : ''}
                                        <div>
                                            <p class="text-xs text-gray-400 mb-1">Data de Criação</p>
                                            <p class="text-sm font-medium text-gray-600">
                                                ${new Date(ordem.created_at).toLocaleDateString('pt-BR')} ${new Date(ordem.created_at).toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'})}
                                            </p>
                                        </div>
                                        ${ordem.completed_at ? `
                                        <div>
                                            <p class="text-xs text-gray-400 mb-1">Data de Conclusão</p>
                                            <p class="text-sm font-medium text-green-600">
                                                ${new Date(ordem.completed_at).toLocaleDateString('pt-BR')} ${new Date(ordem.completed_at).toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'})}
                                            </p>
                                        </div>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="visualizarOrdem(${ordem.id})" class="text-blue-500 hover:text-blue-700 hover:bg-blue-50 p-2 rounded-lg transition" title="Visualizar">
                                    <i data-lucide="eye" class="w-5 h-5"></i>
                                </button>
                                <button onclick="editarOrdem(${ordem.id})" class="text-green-500 hover:text-green-700 hover:bg-green-50 p-2 rounded-lg transition" title="Editar">
                                    <i data-lucide="edit" class="w-5 h-5"></i>
                                </button>
                                <button onclick="excluirOrdem(${ordem.id}, '${ordem.order_number}')" class="text-red-500 hover:text-red-700 hover:bg-red-50 p-2 rounded-lg transition" title="Excluir">
                                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    lista.appendChild(div);
                });
                
                lucide.createIcons();
            } catch (error) {
                console.error('Erro ao filtrar ordens:', error);
                alert('Erro ao filtrar ordens');
            }
        }
    </script>

    <!-- Modal de Ordem de Serviço -->
    <div id="modalOrdem" class="fixed inset-0 bg-black bg-opacity-50 modal-transition hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-gray-900" id="modalTituloOrdem">Nova Ordem de Serviço</h3>
                    <button onclick="fecharModalOrdem()" class="text-gray-400 hover:text-gray-600 transition">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
            </div>

            <form id="formOrdem" onsubmit="salvarOrdem(event)" class="p-6 space-y-4">
                <input type="hidden" id="ordem_id" name="ordem_id">

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Nome do Cliente *</label>
                        <input type="text" id="client_name" name="client_name" required placeholder="Ex: João Silva" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Telefone</label>
                        <input type="text" id="client_phone" name="client_phone" placeholder="(00) 00000-0000" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Email</label>
                    <input type="email" id="client_email" name="client_email" placeholder="cliente@email.com" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Modelo do Aparelho *</label>
                    <input type="text" id="device_model" name="device_model" required placeholder="Ex: iPhone 13, Samsung Galaxy S21" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Descrição do Serviço *</label>
                    <textarea id="service_description" name="service_description" required rows="3" placeholder="Descreva o serviço realizado..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"></textarea>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Peças Utilizadas</label>
                    <div id="listaPecas" class="space-y-2 mb-2"></div>
                    <div class="flex gap-2">
                        <select id="selectPeca" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                            <option value="">Selecione uma peça...</option>
                            {% for peca in pecas %}
                            <option value="{{ peca.id }}" data-price="{{ peca.price }}" data-model="{{ peca.device_model }}" data-part="{{ peca.part_name if peca.part_name else (peca.replaced_part if peca.replaced_part else 'N/A') }}">
                                {{ peca.device_model }} - {{ peca.part_name if peca.part_name else (peca.replaced_part if peca.replaced_part else 'N/A') }} (R$ {{ "%.2f"|format(peca.price) }})
                            </option>
                            {% endfor %}
                        </select>
                        <input type="number" id="quantidadePeca" min="1" value="1" placeholder="Qtd" class="w-20 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                        <button type="button" onclick="adicionarPeca()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">
                            <i data-lucide="plus" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Custo de Mão de Obra</label>
                    <!-- Nota: Serviços devem ser adicionados via API ou interface futura -->
                    <!-- O campo labor_cost foi removido - use a tabela de serviços -->
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Observações</label>
                    <textarea id="notes" name="notes" rows="2" placeholder="Observações adicionais..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"></textarea>
                </div>

                <div id="divStatus" class="hidden">
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Status</label>
                    <select id="status" name="status" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                        <option value="em_andamento">Em Andamento</option>
                        <option value="concluido">Concluída</option>
                        <option value="cancelado">Cancelada</option>
                    </select>
                </div>

                <div class="pt-4 flex justify-end gap-3 border-t border-gray-200 mt-4">
                    <button type="button" onclick="fecharModalOrdem()" class="px-5 py-2 text-sm text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition">Cancelar</button>
                    <button type="submit" class="px-5 py-2 text-sm text-white bg-blue-600 hover:bg-blue-700 rounded-lg shadow-md transition">Salvar Ordem</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Visualização -->
    <div id="modalVisualizar" class="fixed inset-0 bg-black bg-opacity-50 modal-transition hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-gray-900" id="visualizarTitulo">Detalhes da Ordem</h3>
                    <button onclick="fecharModalVisualizar()" class="text-gray-400 hover:text-gray-600 transition">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
            </div>
            <div id="conteudoVisualizar" class="p-6">
                <!-- Conteúdo será preenchido via JavaScript -->
            </div>
        </div>
    </div>
</body>
</html>

