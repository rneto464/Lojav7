<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pe√ßas - Gest√£o de Estoque</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style> 
        body { font-family: 'Inter', sans-serif; background-color: #f9fafb; } 
        .modal-transition { transition: opacity 0.3s ease-in-out; }
        .tab-active { border-bottom: 2px solid #2563eb; color: #2563eb; }
    </style>
</head>
<body class="text-gray-800">

    <div class="bg-blue-600 text-white shadow-lg">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-3">
                    <i data-lucide="wrench" class="w-8 h-8"></i>
                    <div>
                        <h1 class="text-xl font-bold leading-tight">Gest√£o de Estoque</h1>
                        <p class="text-blue-200 text-xs">Sistema Inteligente de Pe√ßas</p>
                    </div>
                </div>
            </div>
            
            <div class="flex space-x-4 text-sm font-medium">
                <a href="/" class="text-blue-100 px-4 py-2 hover:bg-white/10 rounded-md transition">Dashboard</a>
                <a href="/produtos" class="text-blue-100 px-4 py-2 hover:bg-white/10 rounded-md transition">Produtos</a>
                <a href="/fornecedores" class="text-blue-100 px-4 py-2 hover:bg-white/10 rounded-md transition">Fornecedores</a>
                <a href="/reparos" class="bg-white/20 px-4 py-2 rounded-md transition text-white">Pe√ßas</a>
                <a href="/financas" class="text-blue-100 px-4 py-2 hover:bg-white/10 rounded-md transition">Finan√ßas</a>
                <a href="/movimentacoes" class="text-blue-100 px-4 py-2 hover:bg-white/10 rounded-md transition">Movimenta√ß√µes</a>
                <a href="/configuracoes" class="text-blue-100 px-4 py-2 hover:bg-white/10 rounded-md transition flex items-center justify-center" title="Configura√ß√µes">
                    <i data-lucide="settings" class="w-5 h-5"></i>
                </a>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-6 py-8">
        
        <div class="flex justify-between items-center mb-8">
            <div>
                <h2 class="text-3xl font-bold text-gray-900">Pe√ßas e Servi√ßos</h2>
                <p class="text-gray-500 mt-1">Gerencie pe√ßas f√≠sicas e servi√ßos de m√£o de obra</p>
            </div>
            
            <div class="flex gap-3">
                <button id="btnCadastrarServico" onclick="abrirModalServico()" type="button" class="flex items-center gap-2 bg-purple-500 hover:bg-purple-600 text-white px-5 py-2.5 rounded-lg font-medium shadow-md transition transform hover:scale-105">
                    <i data-lucide="wrench" class="w-5 h-5"></i>
                    Cadastrar Servi√ßo
                </button>
                <button id="btnCadastrarPeca" onclick="abrirModal()" type="button" class="flex items-center gap-2 bg-blue-500 hover:bg-blue-600 text-white px-5 py-2.5 rounded-lg font-medium shadow-md transition transform hover:scale-105">
                    <i data-lucide="plus" class="w-5 h-5"></i>
                    <span id="btnTexto">Cadastrar Pe√ßa</span>
                </button>
            </div>
        </div>

        <!-- Tabs -->
        <div class="mb-6 border-b border-gray-200">
            <div class="flex space-x-8">
                <button onclick="mostrarAba('pecas')" id="tab-pecas" class="tab-active pb-3 px-1 text-sm font-medium transition">
                    <i data-lucide="package" class="w-4 h-4 inline mr-2"></i>
                    Cat√°logo de Pe√ßas
                </button>
                <button onclick="mostrarAba('servicos')" id="tab-servicos" class="pb-3 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 transition">
                    <i data-lucide="wrench" class="w-4 h-4 inline mr-2"></i>
                    Tabela de Servi√ßos
                </button>
            </div>
        </div>

        <!-- Conte√∫do: Cat√°logo de Pe√ßas -->
        <div id="conteudo-pecas" class="aba-conteudo">
            <!-- Filtro de Busca por Modelo -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5 mb-6">
                <div class="flex items-center gap-4">
                    <div class="flex-1 relative">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Pesquisar por Modelo de Celular</label>
                        <div class="relative">
                            <i data-lucide="smartphone" class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400"></i>
                            <input type="text" id="filtroModeloPeca" placeholder="Ex: A22, iPhone 14, Samsung S21..." 
                                class="w-full pl-10 pr-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition text-sm">
                        </div>
                    </div>
                    <div class="pt-6">
                        <button type="button" id="limparFiltroPeca" onclick="limparFiltroPeca()" 
                            class="flex items-center gap-2 px-4 py-2.5 text-sm text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-lg transition font-medium">
                            <i data-lucide="x-circle" class="w-4 h-4"></i>
                            Limpar
                        </button>
                    </div>
                </div>
                <div class="mt-4 pt-4 border-t border-gray-100">
                    <p class="text-sm text-gray-600">
                        Mostrando <span id="contadorPecas" class="font-semibold text-blue-600">{{ pecas|length if pecas else 0 }}</span> 
                        de <span class="font-semibold text-gray-700">{{ pecas|length if pecas else 0 }}</span> pe√ßas
                    </p>
                </div>
            </div>

            <div class="space-y-4" id="listaPecasContainer">
                {% if pecas %}
                    {% for peca in pecas %}
                    <div class="peca-card bg-white rounded-xl shadow-sm border border-gray-100 p-6 hover:shadow-md transition" 
                         data-modelo="{{ (peca.device_model or '')|lower }}">
                        <div class="flex justify-between items-start">
                            <div class="flex gap-4 flex-1">
                                <div class="w-12 h-12 rounded-lg bg-orange-50 flex items-center justify-center text-orange-600 shrink-0">
                                    <i data-lucide="package" class="w-6 h-6"></i>
                                </div>
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-2">
                                        <h3 class="text-lg font-bold text-gray-900">{{ peca.device_model }}</h3>
                                        <span class="text-xs font-mono text-gray-400">#{{ peca.id }}</span>
                                    </div>
                                    <p class="text-sm text-gray-600 mb-1">
                                        <span class="font-medium">Pe√ßa:</span> {{ peca.part_name or "N/A" }}
                                    </p>
                                    <div class="flex gap-6 mt-3">
                                        <div>
                                            <p class="text-xs text-gray-400 mb-1">Pre√ßo de Venda</p>
                                            <p class="text-xl font-bold text-emerald-600">
                                                R$ {{ "%.2f"|format(peca.price) }}
                                            </p>
                                        </div>
                                        <div>
                                            <p class="text-xs text-gray-400 mb-1">Estoque</p>
                                            <p class="text-lg font-semibold {% if peca.available_stock <= peca.min_stock_alert %}text-red-600{% else %}text-gray-700{% endif %}">
                                                {{ peca.available_stock }} unidades
                                            </p>
                                        </div>
                                        {% if peca.cost_price and peca.cost_price > 0 %}
                                        <div>
                                            <p class="text-xs text-gray-400 mb-1">Custo de Compra</p>
                                            <p class="text-sm font-medium text-gray-600">
                                                R$ {{ "%.2f"|format(peca.cost_price) }}
                                            </p>
                                        </div>
                                        {% endif %}
                                        <div>
                                            <p class="text-xs text-gray-400 mb-1">Data de Cadastro</p>
                                            <p class="text-sm font-medium text-gray-600">
                                                {{ peca.created_at | formatar_data }}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="editarPeca({{ peca.id }})" class="text-blue-500 hover:text-blue-700 hover:bg-blue-50 p-2 rounded-lg transition" title="Editar">
                                    <i data-lucide="edit" class="w-5 h-5"></i>
                                </button>
                                <button onclick="excluirPeca({{ peca.id }}, '{{ peca.device_model }} - {{ peca.part_name or "N/A" }}')" class="text-red-500 hover:text-red-700 hover:bg-red-50 p-2 rounded-lg transition" title="Excluir">
                                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-12 text-center" id="mensagemVaziaPecas">
                        <div class="inline-block p-4 rounded-full bg-orange-50 mb-4">
                            <i data-lucide="package" class="w-10 h-10 text-orange-500"></i>
                        </div>
                        <h4 class="text-lg font-medium text-gray-900 mb-2">Nenhuma pe√ßa cadastrada</h4>
                        <p class="text-gray-500 text-sm">Comece cadastrando pe√ßas f√≠sicas no cat√°logo.</p>
                    </div>
                {% endif %}
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-12 text-center hidden" id="mensagemSemResultadosPecas">
                    <div class="inline-block p-4 rounded-full bg-orange-50 mb-4">
                        <i data-lucide="search-x" class="w-10 h-10 text-orange-500"></i>
                    </div>
                    <h4 class="text-lg font-medium text-gray-900 mb-2">Nenhuma pe√ßa encontrada</h4>
                    <p class="text-gray-500 text-sm">Tente ajustar o filtro de busca.</p>
                </div>
            </div>
        </div>

        <!-- Conte√∫do: Tabela de Servi√ßos -->
        <div id="conteudo-servicos" class="aba-conteudo hidden">
            <div class="space-y-4">
                {% if servicos %}
                    {% for servico in servicos %}
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 hover:shadow-md transition">
                        <div class="flex justify-between items-center gap-6">
                            <!-- Esquerda: √çcone, Nome e Modelo -->
                            <div class="flex gap-4 flex-1 min-w-0">
                                <div class="w-12 h-12 rounded-lg bg-purple-50 flex items-center justify-center text-purple-600 shrink-0">
                                    <i data-lucide="wrench" class="w-6 h-6"></i>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center gap-2 mb-2">
                                        <h3 class="text-lg font-bold text-gray-900 truncate">{{ servico.name }}</h3>
                                        <span class="text-xs font-mono text-gray-400 shrink-0">#{{ servico.id }}</span>
                                        {% if servico.status == "active" %}
                                        <span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-700 shrink-0">Ativo</span>
                                        {% else %}
                                        <span class="px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-700 shrink-0">Inativo</span>
                                        {% endif %}
                                    </div>
                                    {% if servico.linked_part and servico.linked_part.device_model %}
                                    <p class="text-sm font-medium text-gray-700">
                                        {{ servico.linked_part.device_model }}
                                    </p>
                                    {% elif servico.description %}
                                    <p class="text-sm text-gray-600 truncate">
                                        {{ servico.description }}
                                    </p>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Meio: Pre√ßo, Custo, Lucro e Tempo -->
                            <div class="flex flex-col gap-3 shrink-0">
                                <div>
                                    <p class="text-xs text-gray-400 mb-1">Pre√ßo de Venda</p>
                                    <p class="text-xl font-bold text-emerald-600">
                                        R$ {{ "%.2f"|format(servico.price) }}
                                    </p>
                                </div>
                                {% if servico.linked_part %}
                                    {% set custo_peca = servico.linked_part.cost_price if servico.linked_part.cost_price and servico.linked_part.cost_price > 0 else (servico.linked_part.price * 0.5 if servico.linked_part.price and servico.linked_part.price > 0 else 0) %}
                                    {% set lucro_estimado = servico.price - custo_peca %}
                                    <div>
                                        <p class="text-xs text-gray-400 mb-1">Custo da Pe√ßa</p>
                                        <p class="text-sm font-semibold text-red-600">
                                            - R$ {{ "%.2f"|format(custo_peca) }}
                                        </p>
                                        {% if not servico.linked_part.cost_price or servico.linked_part.cost_price == 0 %}
                                        <p class="text-xs text-yellow-600 mt-0.5">‚ö† Estimativa</p>
                                        {% endif %}
                                    </div>
                                    <div class="border-t border-gray-200 pt-2">
                                        <p class="text-xs text-gray-400 mb-1">Lucro Estimado</p>
                                        <p class="text-lg font-bold {% if lucro_estimado > 0 %}text-green-600{% elif lucro_estimado < 0 %}text-red-600{% else %}text-gray-600{% endif %}">
                                            R$ {{ "%.2f"|format(lucro_estimado) }}
                                        </p>
                                    </div>
                                {% else %}
                                    <div>
                                        <p class="text-xs text-gray-400 mb-1">Lucro Estimado</p>
                                        <p class="text-lg font-bold text-emerald-600">
                                            R$ {{ "%.2f"|format(servico.price) }}
                                        </p>
                                        <p class="text-xs text-gray-500 mt-0.5">Sem pe√ßa vinculada</p>
                                    </div>
                                {% endif %}
                                {% if servico.estimated_time %}
                                <div class="pt-2 border-t border-gray-200">
                                    <p class="text-xs text-gray-400 mb-1">Tempo Estimado</p>
                                    <p class="text-sm font-medium text-gray-600">
                                        {{ servico.estimated_time }} min
                                    </p>
                                </div>
                                {% endif %}
                            </div>
                            
                            <!-- Direita: A√ß√µes (Finalizar, Editar, Excluir) -->
                            <div class="flex items-center gap-2 shrink-0">
                                {% if servico.status == "active" %}
                                <button onclick="finalizarServico({{ servico.id }})" class="flex items-center gap-1.5 bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition font-medium text-sm shadow-sm hover:shadow-md" title="Finalizar Servi√ßo">
                                    <i data-lucide="check-circle" class="w-4 h-4"></i>
                                    Finalizar
                                </button>
                                {% endif %}
                                <button onclick="editarServico({{ servico.id }})" class="flex items-center justify-center w-10 h-10 text-blue-500 hover:text-blue-700 hover:bg-blue-50 rounded-lg transition" title="Editar">
                                    <i data-lucide="edit" class="w-5 h-5"></i>
                                </button>
                                <button onclick="excluirServico({{ servico.id }}, '{{ servico.name }}')" class="flex items-center justify-center w-10 h-10 text-red-500 hover:text-red-700 hover:bg-red-50 rounded-lg transition" title="Excluir">
                                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-12 text-center">
                        <div class="inline-block p-4 rounded-full bg-purple-50 mb-4">
                            <i data-lucide="wrench" class="w-10 h-10 text-purple-500"></i>
                        </div>
                        <h4 class="text-lg font-medium text-gray-900 mb-2">Nenhum servi√ßo cadastrado</h4>
                        <p class="text-gray-500 text-sm">Comece cadastrando servi√ßos de m√£o de obra.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Modal de Cadastro/Edi√ß√£o -->
    <div id="modalPeca" class="fixed inset-0 bg-black bg-opacity-50 modal-transition hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-gray-900" id="modalTitulo">Cadastrar Pe√ßa de Reparo</h3>
                    <button onclick="fecharModal()" class="text-gray-400 hover:text-gray-600 transition">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
            </div>

            <form id="formPeca" onsubmit="salvarPeca(event)" class="p-6 space-y-4">
                <input type="hidden" id="peca_id" name="peca_id">

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Modelo do Aparelho *</label>
                    <input type="text" id="device_model" name="device_model" required placeholder="Ex: iPhone 13, Samsung Galaxy S21" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Nome da Pe√ßa *</label>
                    <input type="text" id="part_name" name="part_name" required placeholder="Ex: Tela, Bateria, Conector de Carga" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Pre√ßo *</label>
                        <input type="number" step="0.01" min="0" id="price" name="price" required placeholder="0.00" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Custo de Compra</label>
                        <input type="number" step="0.01" min="0" id="cost_price" name="cost_price" placeholder="0.00" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Estoque Dispon√≠vel</label>
                        <input type="number" min="0" id="available_stock" name="available_stock" value="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Alerta M√≠nimo de Estoque</label>
                        <input type="number" min="0" id="min_stock_alert" name="min_stock_alert" value="5" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Data de Cadastro (Opcional)</label>
                    <input type="datetime-local" id="peca_created_at" name="peca_created_at" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                    <p class="text-xs text-gray-500 mt-1">Deixe em branco para usar a data/hora atual</p>
                </div>

                <div class="pt-4 flex justify-end gap-3 border-t border-gray-200 mt-4">
                    <button type="button" onclick="fecharModal()" class="px-5 py-2 text-sm text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition">Cancelar</button>
                    <button type="submit" class="px-5 py-2 text-sm text-white bg-blue-600 hover:bg-blue-700 rounded-lg shadow-md transition">Salvar Pe√ßa</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Cadastro/Edi√ß√£o de Servi√ßo -->
    <div id="modalServico" class="fixed inset-0 bg-black bg-opacity-50 modal-transition hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-gray-900" id="modalTituloServico">Cadastrar Servi√ßo</h3>
                    <button onclick="fecharModalServico()" class="text-gray-400 hover:text-gray-600 transition">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
            </div>

            <form id="formServico" onsubmit="salvarServico(event)" class="p-6 space-y-4">
                <input type="hidden" id="servico_id" name="servico_id">

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Nome do Servi√ßo *</label>
                    <input type="text" id="servico_name" name="servico_name" required placeholder="Ex: Troca de Tela, Formata√ß√£o, Limpeza Qu√≠mica" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none">
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Descri√ß√£o</label>
                    <textarea id="servico_description" name="servico_description" rows="3" placeholder="Descri√ß√£o detalhada do servi√ßo (opcional)" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none"></textarea>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Pre√ßo *</label>
                        <input type="number" step="0.01" min="0" id="servico_price" name="servico_price" required placeholder="0.00" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Tempo Estimado (minutos)</label>
                        <input type="number" min="0" id="servico_estimated_time" name="servico_estimated_time" placeholder="Ex: 30" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Pe√ßa Vinculada (Opcional)</label>
                    <select id="servico_linked_part_id" name="servico_linked_part_id" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none">
                        <option value="">Nenhuma pe√ßa vinculada</option>
                        {% for peca in pecas_disponiveis %}
                        <option value="{{ peca.id }}" data-cost="{{ peca.cost_price or 0 }}">
                            {{ peca.device_model }} - {{ peca.part_name or 'N/A' }}
                            {% if peca.cost_price %} (Custo: R$ {{ "%.2f"|format(peca.cost_price) }}){% endif %}
                        </option>
                        {% endfor %}
                    </select>
                    <p class="text-xs text-gray-500 mt-1">Vincule uma pe√ßa para c√°lculo autom√°tico de lucro ao finalizar o servi√ßo</p>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Status</label>
                    <select id="servico_status" name="servico_status" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none">
                        <option value="active">Ativo</option>
                        <option value="inactive">Inativo</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Data de Cadastro (Opcional)</label>
                    <input type="datetime-local" id="servico_created_at" name="servico_created_at" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none">
                    <p class="text-xs text-gray-500 mt-1">Deixe em branco para usar a data/hora atual</p>
                </div>

                <div class="pt-4 flex justify-end gap-3 border-t border-gray-200 mt-4">
                    <button type="button" onclick="fecharModalServico()" class="px-5 py-2 text-sm text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition">Cancelar</button>
                    <button type="submit" class="px-5 py-2 text-sm text-white bg-purple-600 hover:bg-purple-700 rounded-lg shadow-md transition">Salvar Servi√ßo</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        lucide.createIcons();

        let abaAtiva = 'pecas';
        const totalPecas = {{ pecas|length if pecas else 0 }};

        // ===== FILTRO DE BUSCA POR MODELO (PE√áAS) =====
        const filtroModeloPeca = document.getElementById('filtroModeloPeca');
        const contadorPecas = document.getElementById('contadorPecas');
        const mensagemSemResultadosPecas = document.getElementById('mensagemSemResultadosPecas');
        const mensagemVaziaPecas = document.getElementById('mensagemVaziaPecas');

        // Fun√ß√£o para filtrar pe√ßas por modelo
        function filtrarPecas() {
            if (!filtroModeloPeca) return;
            
            const termoModelo = filtroModeloPeca.value.toLowerCase().trim();
            
            const pecas = document.querySelectorAll('.peca-card');
            let pecasVisiveis = 0;
            
            pecas.forEach(peca => {
                const modelo = peca.getAttribute('data-modelo') || '';
                
                const correspondeModelo = !termoModelo || modelo.includes(termoModelo);
                
                if (correspondeModelo) {
                    peca.style.display = '';
                    pecasVisiveis++;
                } else {
                    peca.style.display = 'none';
                }
            });
            
            // Atualiza contador
            if (contadorPecas) {
                contadorPecas.textContent = pecasVisiveis;
            }
            
            // Mostra/oculta mensagens
            if (mensagemSemResultadosPecas) {
                if (pecasVisiveis === 0 && totalPecas > 0) {
                    mensagemSemResultadosPecas.classList.remove('hidden');
                    if (mensagemVaziaPecas) {
                        mensagemVaziaPecas.classList.add('hidden');
                    }
                } else {
                    mensagemSemResultadosPecas.classList.add('hidden');
                    if (mensagemVaziaPecas && totalPecas === 0) {
                        mensagemVaziaPecas.classList.remove('hidden');
                    }
                }
            }
        }

        // Fun√ß√£o para limpar filtro
        function limparFiltroPeca() {
            if (filtroModeloPeca) {
                filtroModeloPeca.value = '';
                filtrarPecas();
                filtroModeloPeca.focus();
            }
        }

        // Event listener para o filtro
        if (filtroModeloPeca) {
            filtroModeloPeca.addEventListener('input', filtrarPecas);
        }

        function mostrarAba(aba) {
            abaAtiva = aba;
            
            // Atualiza tabs
            document.querySelectorAll('[id^="tab-"]').forEach(tab => {
                tab.classList.remove('tab-active', 'text-blue-600');
                tab.classList.add('text-gray-500');
            });
            
            const tabAtiva = document.getElementById(`tab-${aba}`);
            if (tabAtiva) {
                tabAtiva.classList.add('tab-active', 'text-blue-600');
                tabAtiva.classList.remove('text-gray-500');
            }
            
            // Mostra/esconde conte√∫do
            document.querySelectorAll('.aba-conteudo').forEach(conteudo => {
                conteudo.classList.add('hidden');
            });
            
            const conteudoAtivo = document.getElementById(`conteudo-${aba}`);
            if (conteudoAtivo) {
                conteudoAtivo.classList.remove('hidden');
            }
        }

        function abrirModal(pecaId = null) {
            const modal = document.getElementById('modalPeca');
            const form = document.getElementById('formPeca');
            const titulo = document.getElementById('modalTitulo');
            
            if (pecaId) {
                titulo.textContent = 'Editar Pe√ßa';
                carregarPeca(pecaId);
            } else {
                titulo.textContent = 'Cadastrar Pe√ßa';
                form.reset();
                document.getElementById('peca_id').value = '';
            }
            
            modal.classList.remove('hidden');
        }

        function fecharModal() {
            document.getElementById('modalPeca').classList.add('hidden');
        }

        async function carregarPeca(pecaId) {
            try {
                const response = await fetch(`/api/reparos`);
                const pecas = await response.json();
                const peca = pecas.find(p => p.id === pecaId);
                
                if (peca) {
                    document.getElementById('peca_id').value = peca.id;
                    document.getElementById('device_model').value = peca.device_model;
                    document.getElementById('part_name').value = peca.part_name || '';
                    document.getElementById('price').value = peca.price;
                    document.getElementById('cost_price').value = peca.cost_price || '';
                    document.getElementById('available_stock').value = peca.available_stock || 0;
                    document.getElementById('min_stock_alert').value = peca.min_stock_alert || 5;
                    
                    // Carrega data de cadastro se existir
                    if (peca.created_at) {
                        const dataCadastro = new Date(peca.created_at);
                        const dataCadastroLocal = new Date(dataCadastro.getTime() - dataCadastro.getTimezoneOffset() * 60000);
                        document.getElementById('peca_created_at').value = dataCadastroLocal.toISOString().slice(0, 16);
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar pe√ßa:', error);
                alert('Erro ao carregar dados da pe√ßa');
            }
        }

        async function salvarPeca(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const pecaId = document.getElementById('peca_id').value;
            
            const dados = {
                device_model: formData.get('device_model'),
                part_name: formData.get('part_name'),
                price: parseFloat(formData.get('price')),
                cost_price: formData.get('cost_price') ? parseFloat(formData.get('cost_price')) : 0,
                available_stock: parseInt(formData.get('available_stock')) || 0,
                min_stock_alert: parseInt(formData.get('min_stock_alert')) || 5
            };
            
            // Adiciona data personalizada se fornecida
            const dataCadastro = formData.get('peca_created_at');
            if (dataCadastro) {
                dados.created_at = new Date(dataCadastro).toISOString();
            }
            
            try {
                let response;
                if (pecaId) {
                    response = await fetch(`/api/reparos/${pecaId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(dados)
                    });
                } else {
                    response = await fetch('/api/reparos', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(dados)
                    });
                }
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(result.message || 'Pe√ßa salva com sucesso!');
                    fecharModal();
                    location.reload();
                } else {
                    alert(result.message || 'Erro ao salvar pe√ßa');
                }
            } catch (error) {
                console.error('Erro ao salvar pe√ßa:', error);
                alert('Erro ao salvar pe√ßa');
            }
        }

        function editarPeca(pecaId) {
            abrirModal(pecaId);
        }

        async function excluirPeca(pecaId, nome) {
            if (!confirm(`Tem certeza que deseja excluir "${nome}"?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/reparos/${pecaId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(result.message || 'Pe√ßa exclu√≠da com sucesso!');
                    location.reload();
                } else {
                    alert(result.message || 'Erro ao excluir pe√ßa');
                }
            } catch (error) {
                console.error('Erro ao excluir pe√ßa:', error);
                alert('Erro ao excluir pe√ßa');
            }
        }

        // =========================================
        // FUN√á√ïES PARA SERVI√áOS
        // =========================================

        function abrirModalServico(servicoId = null) {
            const modal = document.getElementById('modalServico');
            const form = document.getElementById('formServico');
            const titulo = document.getElementById('modalTituloServico');
            
            if (servicoId) {
                titulo.textContent = 'Editar Servi√ßo';
                carregarServico(servicoId);
            } else {
                titulo.textContent = 'Cadastrar Servi√ßo';
                form.reset();
                document.getElementById('servico_id').value = '';
            }
            
            modal.classList.remove('hidden');
        }

        function fecharModalServico() {
            document.getElementById('modalServico').classList.add('hidden');
        }

        async function carregarServico(servicoId) {
            try {
                const response = await fetch(`/api/servicos`);
                const servicos = await response.json();
                const servico = servicos.find(s => s.id === servicoId);
                
                if (servico) {
                    document.getElementById('servico_id').value = servico.id;
                    document.getElementById('servico_name').value = servico.name;
                    document.getElementById('servico_description').value = servico.description || '';
                    document.getElementById('servico_price').value = servico.price;
                    document.getElementById('servico_estimated_time').value = servico.estimated_time || '';
                    document.getElementById('servico_status').value = servico.status || 'active';
                    document.getElementById('servico_linked_part_id').value = servico.linked_part_id || '';
                }
            } catch (error) {
                console.error('Erro ao carregar servi√ßo:', error);
                alert('Erro ao carregar dados do servi√ßo');
            }
        }

        async function salvarServico(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const servicoId = document.getElementById('servico_id').value;
            
            const linkedPartId = formData.get('servico_linked_part_id');
            const dados = {
                name: formData.get('servico_name'),
                description: formData.get('servico_description') || null,
                price: parseFloat(formData.get('servico_price')),
                estimated_time: formData.get('servico_estimated_time') ? parseInt(formData.get('servico_estimated_time')) : null,
                status: formData.get('servico_status') || 'active',
                linked_part_id: linkedPartId ? parseInt(linkedPartId) : null
            };
            
            // Adiciona data personalizada se fornecida
            const dataCadastro = formData.get('servico_created_at');
            if (dataCadastro) {
                dados.created_at = new Date(dataCadastro).toISOString();
            }
            
            try {
                let response;
                if (servicoId) {
                    response = await fetch(`/api/servicos/${servicoId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(dados)
                    });
                } else {
                    response = await fetch('/api/servicos', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(dados)
                    });
                }
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(result.message || 'Servi√ßo salvo com sucesso!');
                    fecharModalServico();
                    location.reload();
                } else {
                    alert(result.message || 'Erro ao salvar servi√ßo');
                }
            } catch (error) {
                console.error('Erro ao salvar servi√ßo:', error);
                alert('Erro ao salvar servi√ßo');
            }
        }

        function editarServico(servicoId) {
            abrirModalServico(servicoId);
        }

        async function excluirServico(servicoId, nome) {
            if (!confirm(`Tem certeza que deseja excluir o servi√ßo "${nome}"?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/servicos/${servicoId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(result.message || 'Servi√ßo exclu√≠do com sucesso!');
                    location.reload();
                } else {
                    alert(result.message || 'Erro ao excluir servi√ßo');
                }
            } catch (error) {
                console.error('Erro ao excluir servi√ßo:', error);
                alert('Erro ao excluir servi√ßo');
            }
        }

        async function finalizarServico(servicoId) {
            if (!confirm('Deseja finalizar este servi√ßo? O lucro ser√° calculado automaticamente e registrado no hist√≥rico.')) {
                return;
            }
            
            try {
                console.log(`[DEBUG] Finalizando servi√ßo ID: ${servicoId}`);
                const response = await fetch(`/api/servicos/${servicoId}/finalizar`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                console.log(`[DEBUG] Status da resposta: ${response.status}`);
                const result = await response.json();
                console.log('[DEBUG] Resultado:', result);
                
                if (response.ok) {
                    // Mostra mensagem de sucesso com o lucro calculado
                    const lucro = result.data?.profit || result.profit || 0;
                    const mensagem = `‚úÖ Servi√ßo finalizado com sucesso!\n\nüí∞ Lucro registrado: R$ ${lucro.toFixed(2)}\n\nO registro foi salvo na aba "Lucros por Servi√ßo" da p√°gina de Finan√ßas.`;
                    alert(mensagem);
                    console.log('[DEBUG] Recarregando p√°gina...');
                    location.reload();
                } else {
                    console.error('[DEBUG] Erro na resposta:', result);
                    alert('‚ùå Erro ao finalizar servi√ßo: ' + (result.message || result.detail || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('[DEBUG] Erro ao finalizar servi√ßo:', error);
                alert('‚ùå Erro de conex√£o ao finalizar servi√ßo. Verifique sua conex√£o com a internet.\n\nDetalhes: ' + error.message);
            }
        }

    </script>

</body>
</html>

