<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ordens de Serviço - Gestão de Estoque</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style> 
        body { font-family: 'Inter', sans-serif; background-color: #f9fafb; } 
        .modal-transition { transition: opacity 0.3s ease-in-out; }
    </style>
</head>
<body class="text-gray-800">

    <div class="bg-blue-600 text-white shadow-lg">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-3">
                    <i data-lucide="clipboard-list" class="w-8 h-8"></i>
                    <div>
                        <h1 class="text-xl font-bold leading-tight">Gestão de Estoque</h1>
                        <p class="text-blue-200 text-xs">Sistema de Ordens de Serviço</p>
                    </div>
                </div>
            </div>
            
            <div class="flex space-x-4 text-sm font-medium">
                <a href="/" class="text-blue-100 px-4 py-2 hover:bg-white/10 rounded-md transition">Dashboard</a>
                <a href="/produtos" class="text-blue-100 px-4 py-2 hover:bg-white/10 rounded-md transition">Produtos</a>
                <a href="/fornecedores" class="text-blue-100 px-4 py-2 hover:bg-white/10 rounded-md transition">Fornecedores</a>
                <a href="/reparos" class="text-blue-100 px-4 py-2 hover:bg-white/10 rounded-md transition">Peças</a>
                <a href="/financas" class="text-blue-100 px-4 py-2 hover:bg-white/10 rounded-md transition">Finanças</a>
                <a href="/movimentacoes" class="text-blue-100 px-4 py-2 hover:bg-white/10 rounded-md transition">Movimentações</a>
                <a href="/configuracoes" class="text-blue-100 px-4 py-2 hover:bg-white/10 rounded-md transition flex items-center justify-center" title="Configurações">
                    <i data-lucide="settings" class="w-5 h-5"></i>
                </a>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-6 py-8">
        
        <div class="flex justify-between items-center mb-8">
            <div>
                <h2 class="text-3xl font-bold text-gray-900">Ordens de Serviço</h2>
                <p class="text-gray-500 mt-1">Gerencie os serviços realizados com as peças cadastradas</p>
            </div>
            
            <button id="btnNovaOrdem" onclick="abrirModal()" type="button" class="flex items-center gap-2 bg-blue-500 hover:bg-blue-600 text-white px-5 py-2.5 rounded-lg font-medium shadow-md transition transform hover:scale-105">
                <i data-lucide="plus" class="w-5 h-5"></i>
                Nova Ordem
            </button>
        </div>

        <!-- Filtros -->
        <div class="mb-6 flex gap-4">
            <select id="filtroStatus" onchange="filtrarOrdens()" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                <option value="">Todas as ordens</option>
                <option value="em_andamento">Em Andamento</option>
                <option value="concluido">Concluídas</option>
                <option value="cancelado">Canceladas</option>
            </select>
        </div>

        <!-- Lista de Ordens -->
        <div id="listaOrdens" class="space-y-4">
            {% if ordens %}
                {% for ordem in ordens %}
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 hover:shadow-md transition">
                    <div class="flex justify-between items-start">
                        <div class="flex gap-4 flex-1">
                            <div class="w-12 h-12 rounded-lg {% if ordem.status == 'concluido' %}bg-green-50{% elif ordem.status == 'cancelado' %}bg-red-50{% else %}bg-blue-50{% endif %} flex items-center justify-center {% if ordem.status == 'concluido' %}text-green-600{% elif ordem.status == 'cancelado' %}text-red-600{% else %}text-blue-600{% endif %} shrink-0">
                                <i data-lucide="clipboard-list" class="w-6 h-6"></i>
                            </div>
                            <div class="flex-1">
                                <div class="flex items-center gap-3 mb-2">
                                    <h3 class="text-lg font-bold text-gray-900">{{ ordem.order_number }}</h3>
                                    <span class="px-2 py-1 text-xs font-semibold rounded-full {% if ordem.status == 'concluido' %}bg-green-100 text-green-700{% elif ordem.status == 'cancelado' %}bg-red-100 text-red-700{% else %}bg-blue-100 text-blue-700{% endif %}">
                                        {% if ordem.status == 'concluido' %}Concluída{% elif ordem.status == 'cancelado' %}Cancelada{% else %}Em Andamento{% endif %}
                                    </span>
                                </div>
                                <div class="grid grid-cols-2 gap-4 mb-3">
                                    <div>
                                        <p class="text-xs text-gray-400 mb-1">Cliente</p>
                                        <p class="text-sm font-medium text-gray-900">{{ ordem.client_name }}</p>
                                        {% if ordem.client_phone %}
                                        <p class="text-xs text-gray-500">{{ ordem.client_phone }}</p>
                                        {% endif %}
                                    </div>
                                    <div>
                                        <p class="text-xs text-gray-400 mb-1">Aparelho</p>
                                        <p class="text-sm font-medium text-gray-900">{{ ordem.device_model }}</p>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <p class="text-xs text-gray-400 mb-1">Serviço Realizado</p>
                                    <p class="text-sm text-gray-700">{{ ordem.service_description }}</p>
                                </div>
                                <div class="flex gap-6 mt-3">
                                    <div>
                                        <p class="text-xs text-gray-400 mb-1">Valor Total</p>
                                        <p class="text-xl font-bold text-emerald-600">
                                            R$ {{ "%.2f"|format(ordem.total_value or 0) }}
                                        </p>
                                    </div>
                                    {% if ordem.services and ordem.services|length > 0 %}
                                    <div>
                                        <p class="text-xs text-gray-400 mb-1">Serviços</p>
                                        <p class="text-sm font-medium text-gray-600">
                                            {% for service in ordem.services %}
                                                {{ service.name }}{% if service.quantity > 1 %} ({{ service.quantity }}x){% endif %}{% if not loop.last %}, {% endif %}
                                            {% endfor %}
                                        </p>
                                    </div>
                                    {% endif %}
                                    <div>
                                        <p class="text-xs text-gray-400 mb-1">Data de Criação</p>
                                        <p class="text-sm font-medium text-gray-600">
                                            {{ ordem.created_at | formatar_data }}
                                        </p>
                                    </div>
                                    {% if ordem.completed_at %}
                                    <div>
                                        <p class="text-xs text-gray-400 mb-1">Data de Conclusão</p>
                                        <p class="text-sm font-medium text-green-600">
                                            {{ ordem.completed_at | formatar_data }}
                                        </p>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="visualizarOrdem({{ ordem.id }})" class="text-blue-500 hover:text-blue-700 hover:bg-blue-50 p-2 rounded-lg transition" title="Visualizar">
                                <i data-lucide="eye" class="w-5 h-5"></i>
                            </button>
                            <button onclick="editarOrdem({{ ordem.id }})" class="text-green-500 hover:text-green-700 hover:bg-green-50 p-2 rounded-lg transition" title="Editar">
                                <i data-lucide="edit" class="w-5 h-5"></i>
                            </button>
                            <button onclick="excluirOrdem({{ ordem.id }}, '{{ ordem.order_number }}')" class="text-red-500 hover:text-red-700 hover:bg-red-50 p-2 rounded-lg transition" title="Excluir">
                                <i data-lucide="trash-2" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-12 text-center">
                    <div class="inline-block p-4 rounded-full bg-blue-50 mb-4">
                        <i data-lucide="clipboard-list" class="w-10 h-10 text-blue-500"></i>
                    </div>
                    <h4 class="text-lg font-medium text-gray-900 mb-2">Nenhuma ordem de serviço cadastrada</h4>
                    <p class="text-gray-500 text-sm">Comece criando uma nova ordem de serviço.</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Modal de Cadastro/Edição -->
    <div id="modalOrdem" class="fixed inset-0 bg-black bg-opacity-50 modal-transition hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-gray-900" id="modalTitulo">Nova Ordem de Serviço</h3>
                    <button onclick="fecharModal()" class="text-gray-400 hover:text-gray-600 transition">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
            </div>

            <form id="formOrdem" onsubmit="salvarOrdem(event)" class="p-6 space-y-4">
                <input type="hidden" id="ordem_id" name="ordem_id">

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Nome do Cliente *</label>
                        <input type="text" id="client_name" name="client_name" required placeholder="Ex: João Silva" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Telefone</label>
                        <input type="text" id="client_phone" name="client_phone" placeholder="(00) 00000-0000" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Email</label>
                    <input type="email" id="client_email" name="client_email" placeholder="cliente@email.com" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Modelo do Aparelho *</label>
                    <input type="text" id="device_model" name="device_model" required placeholder="Ex: iPhone 13, Samsung Galaxy S21" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Descrição do Serviço *</label>
                    <textarea id="service_description" name="service_description" required rows="3" placeholder="Descreva o serviço realizado..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"></textarea>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Peças Utilizadas</label>
                    <div id="listaPecas" class="space-y-2 mb-2"></div>
                    <div class="flex gap-2">
                        <select id="selectPeca" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                            <option value="">Selecione uma peça...</option>
                            {% for peca in pecas %}
                            <option value="{{ peca.id }}" data-price="{{ peca.price }}" data-model="{{ peca.device_model }}" data-part="{{ peca.part_name if peca.part_name else (peca.replaced_part if peca.replaced_part else 'N/A') }}">
                                {{ peca.device_model }} - {{ peca.part_name if peca.part_name else (peca.replaced_part if peca.replaced_part else 'N/A') }} (R$ {{ "%.2f"|format(peca.price) }})
                            </option>
                            {% endfor %}
                        </select>
                        <input type="number" id="quantidadePeca" min="1" value="1" placeholder="Qtd" class="w-20 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                        <button type="button" onclick="adicionarPeca()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">
                            <i data-lucide="plus" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>

                <!-- Nota: Serviços devem ser adicionados via API ou interface futura -->
                <!-- O campo labor_cost foi removido - use a tabela de serviços -->

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Data de Criação (Opcional)</label>
                        <input type="datetime-local" id="ordem_created_at" name="ordem_created_at" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                        <p class="text-xs text-gray-500 mt-1">Deixe em branco para usar a data/hora atual</p>
                    </div>
                    <div id="divCompletedAt" style="display: none;">
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Data de Conclusão (Opcional)</label>
                        <input type="datetime-local" id="ordem_completed_at" name="ordem_completed_at" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                        <p class="text-xs text-gray-500 mt-1">Apenas para ordens concluídas</p>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Observações</label>
                    <textarea id="notes" name="notes" rows="2" placeholder="Observações adicionais..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"></textarea>
                </div>

                <div id="divStatus" class="hidden">
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Status</label>
                    <select id="status" name="status" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                        <option value="em_andamento">Em Andamento</option>
                        <option value="concluido">Concluído</option>
                        <option value="cancelado">Cancelado</option>
                    </select>
                </div>
                
                <script>
                    // Mostra campo de data de conclusão quando status for "concluido"
                    document.addEventListener('DOMContentLoaded', function() {
                        const statusSelect = document.getElementById('status');
                        const divCompletedAt = document.getElementById('divCompletedAt');
                        if (statusSelect && divCompletedAt) {
                            statusSelect.addEventListener('change', function() {
                                if (this.value === 'concluido') {
                                    divCompletedAt.style.display = 'block';
                                } else {
                                    divCompletedAt.style.display = 'none';
                                    document.getElementById('ordem_completed_at').value = '';
                                }
                            });
                        }
                    });
                </script>
                
                <div id="divStatus" class="hidden">
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Status</label>
                    <select id="status" name="status" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                        <option value="em_andamento">Em Andamento</option>
                        <option value="concluido">Concluída</option>
                        <option value="cancelado">Cancelada</option>
                    </select>
                </div>

                <div class="pt-4 flex justify-end gap-3 border-t border-gray-200 mt-4">
                    <button type="button" onclick="fecharModal()" class="px-5 py-2 text-sm text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition">Cancelar</button>
                    <button type="submit" class="px-5 py-2 text-sm text-white bg-blue-600 hover:bg-blue-700 rounded-lg shadow-md transition">Salvar Ordem</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Visualização -->
    <div id="modalVisualizar" class="fixed inset-0 bg-black bg-opacity-50 modal-transition hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-gray-900" id="visualizarTitulo">Detalhes da Ordem</h3>
                    <button onclick="fecharModalVisualizar()" class="text-gray-400 hover:text-gray-600 transition">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
            </div>
            <div id="conteudoVisualizar" class="p-6">
                <!-- Conteúdo será preenchido via JavaScript -->
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();

        let pecasSelecionadas = [];

        function abrirModal(ordemId = null) {
            const modal = document.getElementById('modalOrdem');
            const form = document.getElementById('formOrdem');
            const titulo = document.getElementById('modalTitulo');
            const divStatus = document.getElementById('divStatus');
            
            if (ordemId) {
                titulo.textContent = 'Editar Ordem de Serviço';
                divStatus.classList.remove('hidden');
                carregarOrdem(ordemId);
            } else {
                titulo.textContent = 'Nova Ordem de Serviço';
                divStatus.classList.add('hidden');
                form.reset();
                document.getElementById('ordem_id').value = '';
                pecasSelecionadas = [];
                atualizarListaPecas();
            }
            
            modal.classList.remove('hidden');
        }

        function fecharModal() {
            document.getElementById('modalOrdem').classList.add('hidden');
        }

        function fecharModalVisualizar() {
            document.getElementById('modalVisualizar').classList.add('hidden');
        }

        function adicionarPeca() {
            const select = document.getElementById('selectPeca');
            const quantidade = document.getElementById('quantidadePeca');
            
            if (!select.value) {
                alert('Selecione uma peça');
                return;
            }
            
            const pecaId = parseInt(select.value);
            const quantidadeVal = parseInt(quantidade.value) || 1;
            const option = select.options[select.selectedIndex];
            const price = parseFloat(option.dataset.price);
            const model = option.dataset.model;
            const part = option.dataset.part;
            
            // Verifica se já existe
            const index = pecasSelecionadas.findIndex(p => p.repair_part_id === pecaId);
            if (index >= 0) {
                pecasSelecionadas[index].quantity += quantidadeVal;
            } else {
                pecasSelecionadas.push({
                    repair_part_id: pecaId,
                    quantity: quantidadeVal,
                    price: price,
                    model: model,
                    part: part
                });
            }
            
            atualizarListaPecas();
            select.value = '';
            quantidade.value = 1;
        }

        function removerPeca(index) {
            pecasSelecionadas.splice(index, 1);
            atualizarListaPecas();
        }

        function atualizarListaPecas() {
            const lista = document.getElementById('listaPecas');
            lista.innerHTML = '';
            
            pecasSelecionadas.forEach((peca, index) => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
                div.innerHTML = `
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-900">${peca.model} - ${peca.part}</p>
                        <p class="text-xs text-gray-500">Qtd: ${peca.quantity} × R$ ${peca.price.toFixed(2)} = R$ ${(peca.quantity * peca.price).toFixed(2)}</p>
                    </div>
                    <button type="button" onclick="removerPeca(${index})" class="text-red-500 hover:text-red-700 p-2">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                `;
                lista.appendChild(div);
            });
            
            lucide.createIcons();
        }

        async function carregarOrdem(ordemId) {
            try {
                const response = await fetch(`/api/ordens-servico/${ordemId}`);
                const ordem = await response.json();
                
                if (ordem) {
                    document.getElementById('ordem_id').value = ordem.id;
                    document.getElementById('client_name').value = ordem.client_name;
                    document.getElementById('client_phone').value = ordem.client_phone || '';
                    document.getElementById('client_email').value = ordem.client_email || '';
                    document.getElementById('device_model').value = ordem.device_model;
                    document.getElementById('service_description').value = ordem.service_description;
                    // labor_cost removido - serviços devem ser gerenciados separadamente
                    document.getElementById('notes').value = ordem.notes || '';
                    document.getElementById('status').value = ordem.status;
                    
                    // Carrega peças
                    pecasSelecionadas = ordem.parts.map(part => ({
                        repair_part_id: part.id,
                        quantity: part.quantity,
                        price: part.price,
                        model: part.device_model,
                        part: part.part_name || part.replaced_part || "N/A"
                    }));
                    atualizarListaPecas();
                }
            } catch (error) {
                console.error('Erro ao carregar ordem:', error);
                alert('Erro ao carregar dados da ordem');
            }
        }

        async function salvarOrdem(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const ordemId = document.getElementById('ordem_id').value;
            
            const dados = {
                client_name: formData.get('client_name'),
                client_phone: formData.get('client_phone') || null,
                client_email: formData.get('client_email') || null,
                device_model: formData.get('device_model'),
                service_description: formData.get('service_description'),
                services: [], // Serviços devem ser adicionados via API separadamente
                notes: formData.get('notes') || null,
                parts: pecasSelecionadas.map(p => ({
                    repair_part_id: p.repair_part_id,
                    quantity: p.quantity
                }))
            };
            
            // Adiciona data personalizada se fornecida
            const dataCriacao = formData.get('ordem_created_at');
            if (dataCriacao) {
                dados.created_at = new Date(dataCriacao).toISOString();
            }
            
            const dataConclusao = formData.get('ordem_completed_at');
            if (dataConclusao) {
                dados.completed_at = new Date(dataConclusao).toISOString();
            }
            
            if (ordemId) {
                dados.status = formData.get('status');
            }
            
            try {
                let response;
                if (ordemId) {
                    response = await fetch(`/api/ordens-servico/${ordemId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(dados)
                    });
                } else {
                    response = await fetch('/api/ordens-servico', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(dados)
                    });
                }
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(result.message || 'Ordem salva com sucesso!');
                    fecharModal();
                    location.reload();
                } else {
                    alert(result.message || 'Erro ao salvar ordem');
                }
            } catch (error) {
                console.error('Erro ao salvar ordem:', error);
                alert('Erro ao salvar ordem');
            }
        }

        async function visualizarOrdem(ordemId) {
            try {
                const response = await fetch(`/api/ordens-servico/${ordemId}`);
                const ordem = await response.json();
                
                const conteudo = document.getElementById('conteudoVisualizar');
                const titulo = document.getElementById('visualizarTitulo');
                titulo.textContent = `Ordem ${ordem.order_number}`;
                
                let html = `
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-xs text-gray-400 mb-1">Cliente</p>
                                <p class="text-sm font-medium text-gray-900">${ordem.client_name}</p>
                                ${ordem.client_phone ? `<p class="text-xs text-gray-500">${ordem.client_phone}</p>` : ''}
                                ${ordem.client_email ? `<p class="text-xs text-gray-500">${ordem.client_email}</p>` : ''}
                            </div>
                            <div>
                                <p class="text-xs text-gray-400 mb-1">Aparelho</p>
                                <p class="text-sm font-medium text-gray-900">${ordem.device_model}</p>
                            </div>
                        </div>
                        <div>
                            <p class="text-xs text-gray-400 mb-1">Descrição do Serviço</p>
                            <p class="text-sm text-gray-700">${ordem.service_description}</p>
                        </div>
                        ${ordem.parts && ordem.parts.length > 0 ? `
                        <div>
                            <p class="text-xs text-gray-400 mb-2">Peças Utilizadas</p>
                            <div class="space-y-2">
                                ${ordem.parts.map(part => `
                                    <div class="p-3 bg-gray-50 rounded-lg">
                                        <p class="text-sm font-medium text-gray-900">${part.device_model} - ${part.part_name || part.replaced_part || 'N/A'}</p>
                                        <p class="text-xs text-gray-500">Quantidade: ${part.quantity} × R$ ${part.price.toFixed(2)} = R$ ${(part.quantity * part.price).toFixed(2)}</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}
                        <div class="grid grid-cols-2 gap-4 pt-4 border-t">
                            ${ordem.services && ordem.services.length > 0 ? `
                            <div>
                                <p class="text-xs text-gray-400 mb-1">Serviços</p>
                                <p class="text-sm font-semibold text-gray-900">
                                    ${ordem.services.map(s => `${s.name}${s.quantity > 1 ? ` (${s.quantity}x)` : ''}`).join(', ')}
                                </p>
                                <p class="text-xs text-gray-500">
                                    Total: R$ ${ordem.services.reduce((sum, s) => sum + (s.price * s.quantity), 0).toFixed(2)}
                                </p>
                            </div>
                            ` : ''}
                            <div>
                                <p class="text-xs text-gray-400 mb-1">Valor Total</p>
                                <p class="text-xl font-bold text-emerald-600">R$ ${ordem.total_value.toFixed(2)}</p>
                            </div>
                        </div>
                        ${ordem.notes ? `
                        <div>
                            <p class="text-xs text-gray-400 mb-1">Observações</p>
                            <p class="text-sm text-gray-700">${ordem.notes}</p>
                        </div>
                        ` : ''}
                        <div class="pt-4 border-t">
                            <p class="text-xs text-gray-400 mb-1">Status</p>
                            <span class="px-2 py-1 text-xs font-semibold rounded-full ${ordem.status === 'concluido' ? 'bg-green-100 text-green-700' : ordem.status === 'cancelado' ? 'bg-red-100 text-red-700' : 'bg-blue-100 text-blue-700'}">
                                ${ordem.status === 'concluido' ? 'Concluída' : ordem.status === 'cancelado' ? 'Cancelada' : 'Em Andamento'}
                            </span>
                        </div>
                    </div>
                `;
                
                conteudo.innerHTML = html;
                document.getElementById('modalVisualizar').classList.remove('hidden');
            } catch (error) {
                console.error('Erro ao visualizar ordem:', error);
                alert('Erro ao carregar ordem');
            }
        }

        function editarOrdem(ordemId) {
            abrirModal(ordemId);
        }

        async function excluirOrdem(ordemId, numero) {
            if (!confirm(`Tem certeza que deseja excluir a ordem "${numero}"?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/ordens-servico/${ordemId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(result.message || 'Ordem excluída com sucesso!');
                    location.reload();
                } else {
                    alert(result.message || 'Erro ao excluir ordem');
                }
            } catch (error) {
                console.error('Erro ao excluir ordem:', error);
                alert('Erro ao excluir ordem');
            }
        }

        async function filtrarOrdens() {
            const status = document.getElementById('filtroStatus').value;
            const url = status ? `/api/ordens-servico?status=${status}` : '/api/ordens-servico';
            
            try {
                const response = await fetch(url);
                const ordens = await response.json();
                
                const lista = document.getElementById('listaOrdens');
                lista.innerHTML = '';
                
                if (ordens.length === 0) {
                    lista.innerHTML = `
                        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-12 text-center">
                            <div class="inline-block p-4 rounded-full bg-blue-50 mb-4">
                                <i data-lucide="clipboard-list" class="w-10 h-10 text-blue-500"></i>
                            </div>
                            <h4 class="text-lg font-medium text-gray-900 mb-2">Nenhuma ordem encontrada</h4>
                            <p class="text-gray-500 text-sm">Não há ordens com o filtro selecionado.</p>
                        </div>
                    `;
                    lucide.createIcons();
                    return;
                }
                
                ordens.forEach(ordem => {
                    const div = document.createElement('div');
                    div.className = 'bg-white rounded-xl shadow-sm border border-gray-100 p-6 hover:shadow-md transition';
                    div.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div class="flex gap-4 flex-1">
                                <div class="w-12 h-12 rounded-lg ${ordem.status === 'concluido' ? 'bg-green-50' : ordem.status === 'cancelado' ? 'bg-red-50' : 'bg-blue-50'} flex items-center justify-center ${ordem.status === 'concluido' ? 'text-green-600' : ordem.status === 'cancelado' ? 'text-red-600' : 'text-blue-600'} shrink-0">
                                    <i data-lucide="clipboard-list" class="w-6 h-6"></i>
                                </div>
                                <div class="flex-1">
                                    <div class="flex items-center gap-3 mb-2">
                                        <h3 class="text-lg font-bold text-gray-900">${ordem.order_number}</h3>
                                        <span class="px-2 py-1 text-xs font-semibold rounded-full ${ordem.status === 'concluido' ? 'bg-green-100 text-green-700' : ordem.status === 'cancelado' ? 'bg-red-100 text-red-700' : 'bg-blue-100 text-blue-700'}">
                                            ${ordem.status === 'concluido' ? 'Concluída' : ordem.status === 'cancelado' ? 'Cancelada' : 'Em Andamento'}
                                        </span>
                                    </div>
                                    <div class="grid grid-cols-2 gap-4 mb-3">
                                        <div>
                                            <p class="text-xs text-gray-400 mb-1">Cliente</p>
                                            <p class="text-sm font-medium text-gray-900">${ordem.client_name}</p>
                                            ${ordem.client_phone ? `<p class="text-xs text-gray-500">${ordem.client_phone}</p>` : ''}
                                        </div>
                                        <div>
                                            <p class="text-xs text-gray-400 mb-1">Aparelho</p>
                                            <p class="text-sm font-medium text-gray-900">${ordem.device_model}</p>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <p class="text-xs text-gray-400 mb-1">Serviço Realizado</p>
                                        <p class="text-sm text-gray-700">${ordem.service_description}</p>
                                    </div>
                                    <div class="flex gap-6 mt-3">
                                        <div>
                                            <p class="text-xs text-gray-400 mb-1">Valor Total</p>
                                            <p class="text-xl font-bold text-emerald-600">
                                                R$ ${ordem.total_value.toFixed(2)}
                                            </p>
                                        </div>
                                        ${ordem.services && ordem.services.length > 0 ? `
                                        <div>
                                            <p class="text-xs text-gray-400 mb-1">Serviços</p>
                                            <p class="text-sm font-medium text-gray-600">
                                                ${ordem.services.map(s => `${s.name}${s.quantity > 1 ? ` (${s.quantity}x)` : ''}`).join(', ')}
                                            </p>
                                        </div>
                                        ` : ''}
                                        <div>
                                            <p class="text-xs text-gray-400 mb-1">Data</p>
                                            <p class="text-sm font-medium text-gray-600">
                                                ${new Date(ordem.created_at).toLocaleDateString('pt-BR')}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="visualizarOrdem(${ordem.id})" class="text-blue-500 hover:text-blue-700 hover:bg-blue-50 p-2 rounded-lg transition" title="Visualizar">
                                    <i data-lucide="eye" class="w-5 h-5"></i>
                                </button>
                                <button onclick="editarOrdem(${ordem.id})" class="text-green-500 hover:text-green-700 hover:bg-green-50 p-2 rounded-lg transition" title="Editar">
                                    <i data-lucide="edit" class="w-5 h-5"></i>
                                </button>
                                <button onclick="excluirOrdem(${ordem.id}, '${ordem.order_number}')" class="text-red-500 hover:text-red-700 hover:bg-red-50 p-2 rounded-lg transition" title="Excluir">
                                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    lista.appendChild(div);
                });
                
                lucide.createIcons();
            } catch (error) {
                console.error('Erro ao filtrar ordens:', error);
                alert('Erro ao filtrar ordens');
            }
        }
    </script>
</body>
</html>

