<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finanças - Gestão de Estoque</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style> 
        body { font-family: 'Inter', sans-serif; background-color: #f9fafb; } 
        .modal-transition { transition: opacity 0.3s ease-in-out; }
    </style>
</head>
<body class="text-gray-800">

    <div class="bg-blue-600 text-white shadow-lg">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-3">
                    <i data-lucide="dollar-sign" class="w-8 h-8"></i>
                    <div>
                        <h1 class="text-xl font-bold leading-tight">Gestão de Estoque</h1>
                        <p class="text-blue-200 text-xs">Sistema de Finanças</p>
                    </div>
                </div>
            </div>
            
            <div class="flex space-x-4 text-sm font-medium">
                <a href="/" class="text-blue-100 px-4 py-2 hover:bg-white/10 rounded-md transition">Dashboard</a>
                <a href="/produtos" class="text-blue-100 px-4 py-2 hover:bg-white/10 rounded-md transition">Produtos</a>
                <a href="/fornecedores" class="text-blue-100 px-4 py-2 hover:bg-white/10 rounded-md transition">Fornecedores</a>
                <a href="/reparos" class="text-blue-100 px-4 py-2 hover:bg-white/10 rounded-md transition">Peças</a>
                <a href="/financas" class="bg-white/20 px-4 py-2 rounded-md transition text-white whitespace-nowrap">Finanças</a>
                <a href="/movimentacoes" class="text-blue-100 px-4 py-2 hover:bg-white/10 rounded-md transition">Movimentações</a>
                <a href="/configuracoes" class="text-blue-100 px-4 py-2 hover:bg-white/10 rounded-md transition flex items-center justify-center" title="Configurações">
                    <i data-lucide="settings" class="w-5 h-5"></i>
                </a>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-6 py-8">
        
        <!-- Resumo Financeiro -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs text-gray-500 mb-1">Total em Compras</p>
                        <p class="text-2xl font-bold text-gray-900" id="totalCompras">R$ 0,00</p>
                    </div>
                    <div class="w-12 h-12 rounded-lg bg-blue-50 text-blue-600 flex items-center justify-center">
                        <i data-lucide="shopping-cart" class="w-6 h-6"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs text-gray-500 mb-1">Total em Serviços</p>
                        <p class="text-2xl font-bold text-gray-900" id="totalServicos">R$ 0,00</p>
                    </div>
                    <div class="w-12 h-12 rounded-lg bg-green-50 text-green-600 flex items-center justify-center">
                        <i data-lucide="dollar-sign" class="w-6 h-6"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs text-gray-500 mb-1">Lucro Total</p>
                        <p class="text-2xl font-bold text-gray-900" id="lucroTotal">R$ 0,00</p>
                    </div>
                    <div class="w-12 h-12 rounded-lg bg-purple-50 text-purple-600 flex items-center justify-center">
                        <i data-lucide="trending-up" class="w-6 h-6"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs text-gray-500 mb-1">Margem Média</p>
                        <p class="text-2xl font-bold text-gray-900" id="margemMedia">0%</p>
                    </div>
                    <div class="w-12 h-12 rounded-lg bg-yellow-50 text-yellow-600 flex items-center justify-center">
                        <i data-lucide="percent" class="w-6 h-6"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="mb-6 border-b border-gray-200">
            <div class="flex space-x-8">
                <button onclick="mostrarAba('compras')" id="tabCompras" class="pb-4 px-1 border-b-2 border-blue-500 text-blue-600 font-semibold text-sm">
                    Compras de Peças
                </button>
                <button onclick="mostrarAba('lucros')" id="tabLucros" class="pb-4 px-1 border-b-2 border-transparent text-gray-500 font-semibold text-sm hover:text-gray-700">
                    Lucros por Serviço
                </button>
            </div>
        </div>

        <!-- Aba Compras -->
        <div id="abaCompras" class="aba-conteudo">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-gray-900">Compras de Peças</h2>
                    <p class="text-gray-500 mt-1">Registre as compras de peças e o frete pago</p>
                </div>
                
                <button onclick="abrirModalCompra()" type="button" class="flex items-center gap-2 bg-blue-500 hover:bg-blue-600 text-white px-5 py-2.5 rounded-lg font-medium shadow-md transition transform hover:scale-105">
                    <i data-lucide="plus" class="w-5 h-5"></i>
                    Nova Compra
                </button>
            </div>

            <!-- Lista de Compras -->
            <div id="listaCompras" class="space-y-4">
                {% if purchases %}
                    {% for purchase in purchases %}
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 hover:shadow-md transition">
                        <div class="flex justify-between items-start">
                            <div class="flex gap-4 flex-1">
                                <div class="w-12 h-12 rounded-lg bg-green-50 text-green-600 flex items-center justify-center shrink-0">
                                    <i data-lucide="shopping-cart" class="w-6 h-6"></i>
                                </div>
                                <div class="flex-1">
                                    <div class="flex items-center gap-3 mb-2">
                                        <h3 class="text-lg font-bold text-gray-900">{{ purchase.purchase_number }}</h3>
                                        <span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-700">
                                            Compra
                                        </span>
                                    </div>
                                    <div class="grid grid-cols-2 gap-4 mb-3">
                                        <div>
                                            <p class="text-xs text-gray-400 mb-1">Fornecedor</p>
                                            <p class="text-sm font-medium text-gray-900">{{ purchase.supplier_name }}</p>
                                        </div>
                                        <div>
                                            <p class="text-xs text-gray-400 mb-1">Data da Compra</p>
                                            <p class="text-sm font-medium text-gray-900">
                                                {{ purchase.created_at | formatar_data }}
                                            </p>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <p class="text-xs text-gray-400 mb-2">Itens Comprados</p>
                                        <div class="space-y-1">
                                            {% if purchase['items'] %}
                                            {% for item in purchase['items'] %}
                                            <div class="flex justify-between text-sm">
                                                <span class="text-gray-700">{{ item.repair_part.device_model if item.repair_part else "N/A" }} - {{ item.repair_part.part_name if item.repair_part and item.repair_part.part_name else "N/A" }}</span>
                                                <span class="text-gray-900 font-medium">{{ item.quantity }}x R$ {{ "%.2f"|format(item.unit_cost) }}</span>
                                            </div>
                                            {% endfor %}
                                            {% else %}
                                            <p class="text-sm text-gray-500">Nenhum item registrado</p>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="flex gap-6 mt-3">
                                        <div>
                                            <p class="text-xs text-gray-400 mb-1">Valor das Peças</p>
                                            <p class="text-sm font-semibold text-gray-900">R$ {{ "%.2f"|format(purchase.total_value - purchase.shipping_cost) }}</p>
                                        </div>
                                        <div>
                                            <p class="text-xs text-gray-400 mb-1">Frete</p>
                                            <p class="text-sm font-semibold text-gray-900">R$ {{ "%.2f"|format(purchase.shipping_cost) }}</p>
                                        </div>
                                        <div>
                                            <p class="text-xs text-gray-400 mb-1">Total</p>
                                            <p class="text-lg font-bold text-green-600">R$ {{ "%.2f"|format(purchase.total_value) }}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-12 text-center">
                        <i data-lucide="shopping-cart" class="w-16 h-16 text-gray-300 mx-auto mb-4"></i>
                        <p class="text-gray-500 text-lg mb-2">Nenhuma compra registrada</p>
                        <p class="text-gray-400 text-sm">Clique em "Nova Compra" para começar</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Aba Lucros -->
        <div id="abaLucros" class="aba-conteudo hidden">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-gray-900">Lucros por Serviço</h2>
                    <p class="text-gray-500 mt-1">Visualize o lucro de cada ordem de serviço realizada</p>
                </div>
            </div>

            <!-- Lista de Lucros -->
            <div id="listaLucros" class="space-y-4">
                {% if service_orders %}
                    {% for order in service_orders %}
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 hover:shadow-md transition">
                        <div class="flex justify-between items-start">
                            <div class="flex gap-4 flex-1">
                                <div class="w-12 h-12 rounded-lg {% if order.lucro > 0 %}bg-green-50 text-green-600{% elif order.lucro < 0 %}bg-red-50 text-red-600{% else %}bg-gray-50 text-gray-600{% endif %} flex items-center justify-center shrink-0">
                                    <i data-lucide="dollar-sign" class="w-6 h-6"></i>
                                </div>
                                <div class="flex-1">
                                    <div class="flex items-center gap-3 mb-2">
                                        <h3 class="text-lg font-bold text-gray-900">{{ order.order_number }}</h3>
                                        <span class="px-2 py-1 text-xs font-semibold rounded-full {% if order.status == 'concluido' %}bg-green-100 text-green-700{% elif order.status == 'cancelado' %}bg-red-100 text-red-700{% else %}bg-blue-100 text-blue-700{% endif %}">
                                            {% if order.status == 'concluido' %}Concluída{% elif order.status == 'cancelado' %}Cancelada{% else %}Em Andamento{% endif %}
                                        </span>
                                    </div>
                                    <div class="grid grid-cols-2 gap-4 mb-3">
                                        <div>
                                            <p class="text-xs text-gray-400 mb-1">Cliente</p>
                                            <p class="text-sm font-medium text-gray-900">{{ order.client_name }}</p>
                                        </div>
                                        <div>
                                            <p class="text-xs text-gray-400 mb-1">Aparelho</p>
                                            <p class="text-sm font-medium text-gray-900">{{ order.device_model }}</p>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <p class="text-xs text-gray-400 mb-1">Serviço</p>
                                        <p class="text-sm text-gray-700">{{ order.service_description }}</p>
                                    </div>
                                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4 p-4 bg-gray-50 rounded-lg">
                                        <div>
                                            <p class="text-xs text-gray-400 mb-1">Receita</p>
                                            <p class="text-sm font-semibold text-gray-900">R$ {{ "%.2f"|format(order.total_value) }}</p>
                                        </div>
                                        <div>
                                            <p class="text-xs text-gray-400 mb-1">Custo Peças</p>
                                            <p class="text-sm font-semibold text-red-600">- R$ {{ "%.2f"|format(order.custo_pecas) }}</p>
                                            {% if order.pecas_sem_custo and order.pecas_sem_custo|length > 0 %}
                                            <p class="text-xs text-yellow-600 mt-1" title="Algumas peças não têm custo definido, usando estimativa">
                                                ⚠ Estimativa
                                            </p>
                                            {% endif %}
                                        </div>
                                        {% if order.services and order.services|length > 0 %}
                                        <div>
                                            <p class="text-xs text-gray-400 mb-1">Serviços</p>
                                            <p class="text-sm font-semibold text-gray-600">
                                                {% for service in order.services %}
                                                    {{ service.name }}{% if service.quantity > 1 %} ({{ service.quantity }}x){% endif %}{% if not loop.last %}, {% endif %}
                                                {% endfor %}
                                            </p>
                                            <p class="text-xs text-gray-500">Total: R$ {{ "%.2f"|format(order.services|sum(attribute='price') * order.services|sum(attribute='quantity')) }}</p>
                                        </div>
                                        {% endif %}
                                        <div>
                                            <p class="text-xs text-gray-400 mb-1">Lucro</p>
                                            <p class="text-lg font-bold {% if order.lucro > 0 %}text-green-600{% elif order.lucro < 0 %}text-red-600{% else %}text-gray-600{% endif %}">
                                                R$ {{ "%.2f"|format(order.lucro) }}
                                            </p>
                                            <p class="text-xs {% if order.lucro > 0 %}text-green-600{% elif order.lucro < 0 %}text-red-600{% else %}text-gray-600{% endif %}">
                                                ({{ "%.1f"|format(order.margem_lucro) }}%)
                                            </p>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-2 gap-4 mt-3 pt-3 border-t border-gray-200">
                                        <div>
                                            <p class="text-xs text-gray-400 mb-1">Data de Criação</p>
                                            <p class="text-sm font-medium text-gray-600">
                                                {{ order.created_at | formatar_data }}
                                            </p>
                                        </div>
                                        {% if order.completed_at %}
                                        <div>
                                            <p class="text-xs text-gray-400 mb-1">Data de Conclusão</p>
                                            <p class="text-sm font-medium text-green-600">
                                                {{ order.completed_at | formatar_data }}
                                            </p>
                                        </div>
                                        {% endif %}
                                    </div>
                                    {% if order.pecas_sem_custo and order.pecas_sem_custo|length > 0 %}
                                    <div class="mt-3 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                                        <p class="text-xs font-semibold text-yellow-800 mb-1">⚠ Atenção: Peças sem custo definido</p>
                                        <p class="text-xs text-yellow-700">
                                            As seguintes peças não têm custo de compra cadastrado. O lucro está sendo calculado com estimativa (50% do preço):
                                        </p>
                                        <ul class="text-xs text-yellow-700 mt-1 list-disc list-inside">
                                            {% for peca in order.pecas_sem_custo %}
                                            <li>{{ peca.nome }} (Preço: R$ {{ "%.2f"|format(peca.preco) }})</li>
                                            {% endfor %}
                                        </ul>
                                        <p class="text-xs text-yellow-700 mt-2">
                                            Para calcular o lucro corretamente, cadastre o custo de compra dessas peças na página de Peças.
                                        </p>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% endif %}
                
                <!-- Vendas de Serviços (Finalizadas diretamente do card) -->
                {% if service_sales %}
                    {% for sale in service_sales %}
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 hover:shadow-md transition">
                        <div class="flex justify-between items-start">
                            <div class="flex gap-4 flex-1">
                                <div class="w-12 h-12 rounded-lg {% if sale.profit > 0 %}bg-green-50 text-green-600{% elif sale.profit < 0 %}bg-red-50 text-red-600{% else %}bg-gray-50 text-gray-600{% endif %} flex items-center justify-center shrink-0">
                                    <i data-lucide="wrench" class="w-6 h-6"></i>
                                </div>
                                <div class="flex-1">
                                    <div class="flex items-center gap-3 mb-2">
                                        <h3 class="text-lg font-bold text-gray-900">{{ sale.service_name }}</h3>
                                        <span class="px-2 py-1 text-xs font-semibold rounded-full bg-purple-100 text-purple-700">
                                            Serviço Finalizado
                                        </span>
                                    </div>
                                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4 p-4 bg-gray-50 rounded-lg">
                                        <div>
                                            <p class="text-xs text-gray-400 mb-1">Receita</p>
                                            <p class="text-sm font-semibold text-gray-900">R$ {{ "%.2f"|format(sale.sale_price) }}</p>
                                        </div>
                                        {% if sale.part_cost %}
                                        <div>
                                            <p class="text-xs text-gray-400 mb-1">Custo da Peça</p>
                                            <p class="text-sm font-semibold text-red-600">- R$ {{ "%.2f"|format(sale.part_cost) }}</p>
                                        </div>
                                        {% else %}
                                        <div>
                                            <p class="text-xs text-gray-400 mb-1">Custo</p>
                                            <p class="text-sm font-semibold text-gray-500">Sem peça vinculada</p>
                                        </div>
                                        {% endif %}
                                        <div>
                                            <p class="text-xs text-gray-400 mb-1">Lucro</p>
                                            <p class="text-lg font-bold {% if sale.profit > 0 %}text-green-600{% elif sale.profit < 0 %}text-red-600{% else %}text-gray-600{% endif %}">
                                                R$ {{ "%.2f"|format(sale.profit) }}
                                            </p>
                                        </div>
                                        <div>
                                            <p class="text-xs text-gray-400 mb-1">Data</p>
                                            <p class="text-sm font-medium text-gray-600">
                                                {{ sale.sold_at | formatar_data }}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% endif %}
                
                {% if not service_orders and not service_sales %}
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-12 text-center">
                        <i data-lucide="dollar-sign" class="w-16 h-16 text-gray-300 mx-auto mb-4"></i>
                        <p class="text-gray-500 text-lg mb-2">Nenhum lucro registrado</p>
                        <p class="text-gray-400 text-sm">Finalize serviços ou ordens de serviço para visualizar os lucros</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Modal de Nova Compra -->
    <div id="modalCompra" class="fixed inset-0 bg-black bg-opacity-50 modal-transition hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-gray-900">Nova Compra de Peças</h3>
                    <button onclick="fecharModalCompra()" class="text-gray-400 hover:text-gray-600 transition">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
            </div>

            <form id="formCompra" onsubmit="salvarCompra(event)" class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Fornecedor *</label>
                    <input type="text" id="supplier_name" name="supplier_name" required placeholder="Ex: Fornecedor XYZ" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Frete (R$)</label>
                        <input type="number" id="shipping_cost" name="shipping_cost" step="0.01" min="0" value="0" placeholder="0.00" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Data da Compra (Opcional)</label>
                        <input type="datetime-local" id="compra_created_at" name="compra_created_at" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                        <p class="text-xs text-gray-500 mt-1">Deixe em branco para usar a data/hora atual</p>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Observações</label>
                    <textarea id="notes" name="notes" rows="3" placeholder="Observações sobre a compra..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"></textarea>
                </div>

                <div>
                    <div class="flex justify-between items-center mb-3">
                        <label class="block text-sm font-semibold text-gray-700">Itens da Compra *</label>
                        <button type="button" onclick="adicionarItemCompra()" class="text-sm text-blue-600 hover:text-blue-700 font-medium">
                            + Adicionar Item
                        </button>
                    </div>
                    <div id="itensCompra" class="space-y-3">
                        <!-- Itens serão adicionados aqui via JavaScript -->
                    </div>
                </div>

                <div class="flex gap-3 pt-4 border-t border-gray-200">
                    <button type="submit" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white px-5 py-2.5 rounded-lg font-medium transition">
                        Salvar Compra
                    </button>
                    <button type="button" onclick="fecharModalCompra()" class="px-5 py-2.5 border border-gray-300 rounded-lg font-medium text-gray-700 hover:bg-gray-50 transition">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Inicializar ícones
        lucide.createIcons();

        // Dados das peças disponíveis (será carregado via API)
        let pecasDisponiveis = [];

        // Carregar peças ao abrir o modal
        async function carregarPecas() {
            try {
                const response = await fetch('/api/reparos');
                if (response.ok) {
                    pecasDisponiveis = await response.json();
                    return true;
                }
            } catch (error) {
                console.error('Erro ao carregar peças:', error);
            }
            return false;
        }

        // Funções de abas
        function mostrarAba(aba) {
            document.getElementById('abaCompras').classList.toggle('hidden', aba !== 'compras');
            document.getElementById('abaLucros').classList.toggle('hidden', aba !== 'lucros');
            
            const tabCompras = document.getElementById('tabCompras');
            const tabLucros = document.getElementById('tabLucros');
            
            if (aba === 'compras') {
                tabCompras.classList.add('border-blue-500', 'text-blue-600');
                tabCompras.classList.remove('border-transparent', 'text-gray-500');
                tabLucros.classList.remove('border-blue-500', 'text-blue-600');
                tabLucros.classList.add('border-transparent', 'text-gray-500');
            } else {
                tabLucros.classList.add('border-blue-500', 'text-blue-600');
                tabLucros.classList.remove('border-transparent', 'text-gray-500');
                tabCompras.classList.remove('border-blue-500', 'text-blue-600');
                tabCompras.classList.add('border-transparent', 'text-gray-500');
            }
        }

        // Funções do modal de compra
        async function abrirModalCompra() {
            document.getElementById('modalCompra').classList.remove('hidden');
            document.getElementById('itensCompra').innerHTML = '';
            
            // Carrega as peças primeiro, depois adiciona o primeiro item
            const pecasCarregadas = await carregarPecas();
            if (pecasCarregadas) {
                adicionarItemCompra();
            } else {
                alert('Erro ao carregar peças. Tente novamente.');
            }
        }

        function fecharModalCompra() {
            document.getElementById('modalCompra').classList.add('hidden');
            document.getElementById('formCompra').reset();
        }

        function adicionarItemCompra() {
            // Verifica se as peças foram carregadas
            if (!pecasDisponiveis || pecasDisponiveis.length === 0) {
                alert('Aguarde o carregamento das peças ou recarregue a página.');
                return;
            }
            
            const container = document.getElementById('itensCompra');
            const itemIndex = container.children.length;
            
            const itemDiv = document.createElement('div');
            itemDiv.className = 'border border-gray-200 rounded-lg p-4 bg-gray-50';
            itemDiv.innerHTML = `
                <div class="grid grid-cols-3 gap-3">
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Peça</label>
                        <select name="repair_part_id[]" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-sm">
                            <option value="">Selecione...</option>
                            ${pecasDisponiveis.map(peca => `
                                <option value="${peca.id}">${peca.device_model} - ${peca.part_name || 'N/A'}</option>
                            `).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Quantidade</label>
                        <input type="number" name="quantity[]" required min="1" value="1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Custo Unitário (R$)</label>
                        <input type="number" name="unit_cost[]" required step="0.01" min="0" placeholder="0.00" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-sm">
                    </div>
                </div>
                ${itemIndex > 0 ? `
                    <button type="button" onclick="this.parentElement.remove()" class="mt-2 text-xs text-red-600 hover:text-red-700">
                        Remover item
                    </button>
                ` : ''}
            `;
            container.appendChild(itemDiv);
            lucide.createIcons();
        }

        async function salvarCompra(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const supplier_name = formData.get('supplier_name');
            const shipping_cost = parseFloat(formData.get('shipping_cost') || 0);
            const notes = formData.get('notes');
            
            const items = [];
            const partIds = formData.getAll('repair_part_id[]');
            const quantities = formData.getAll('quantity[]');
            const unitCosts = formData.getAll('unit_cost[]');
            
            for (let i = 0; i < partIds.length; i++) {
                if (partIds[i]) {
                    items.push({
                        repair_part_id: parseInt(partIds[i]),
                        quantity: parseInt(quantities[i]),
                        unit_cost: parseFloat(unitCosts[i])
                    });
                }
            }
            
            if (items.length === 0) {
                alert('Adicione pelo menos um item à compra');
                return;
            }
            
            // Adiciona data personalizada se fornecida
            const dataCompra = formData.get('compra_created_at');
            const compraData = {
                supplier_name,
                shipping_cost,
                items,
                notes
            };
            
            if (dataCompra) {
                compraData.created_at = new Date(dataCompra).toISOString();
            }
            
            try {
                const response = await fetch('/api/compras', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(compraData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('Compra registrada com sucesso!');
                    location.reload();
                } else {
                    alert('Erro ao registrar compra: ' + (result.message || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao registrar compra');
            }
        }

        // Calcular totais
        function calcularTotais() {
            let totalCompras = 0;
            let totalServicos = 0;
            let lucroTotal = 0;
            let margens = [];
            
            // Calcula totais das compras
            {% for purchase in purchases %}
                totalCompras += {{ purchase.total_value or 0 }};
            {% endfor %}
            
            // Calcula totais das ordens de serviço
            {% for order in service_orders %}
                totalServicos += {{ order.total_value or 0 }};
                lucroTotal += {{ order.lucro or 0 }};
                {% if order.margem_lucro %}
                    margens.push({{ order.margem_lucro }});
                {% endif %}
            {% endfor %}
            
            // Calcula totais dos serviços finalizados diretamente do card (service_sales)
            {% if service_sales %}
            const serviceSalesData = [
                {% for sale in service_sales %}
                {
                    sale_price: {{ sale.sale_price or 0 }},
                    profit: {{ sale.profit or 0 }}
                }{% if not loop.last %},{% endif %}
                {% endfor %}
            ];
            
            serviceSalesData.forEach(sale => {
                totalServicos += sale.sale_price;
                lucroTotal += sale.profit;
                if (sale.sale_price > 0) {
                    const margemSale = (sale.profit / sale.sale_price) * 100;
                    margens.push(margemSale);
                }
            });
            {% endif %}
            
            const margemMedia = margens.length > 0 ? margens.reduce((a, b) => a + b, 0) / margens.length : 0;
            
            document.getElementById('totalCompras').textContent = formatarMoeda(totalCompras);
            document.getElementById('totalServicos').textContent = formatarMoeda(totalServicos);
            document.getElementById('lucroTotal').textContent = formatarMoeda(lucroTotal);
            document.getElementById('margemMedia').textContent = margemMedia.toFixed(1) + '%';
        }

        function formatarMoeda(valor) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(valor);
        }

        // Inicializar
        calcularTotais();
    </script>
</body>
</html>

